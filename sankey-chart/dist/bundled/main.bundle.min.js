!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SankeyChartLibrary=e():t.SankeyChartLibrary=e()}(this,(()=>(()=>{"use strict";var t,e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};e.r(i),e.d(i,{EventHandler:()=>s,IncludeKind:()=>t,Minimap:()=>a,SankeyChart:()=>o,SankeyChartData:()=>n}),function(t){t.WITH_SAME_TARGET="WITH_SAME_TARGET"}(t||(t={}));class n{constructor(t,e,i=!1){this.getNodeTagColor=t=>{const e=t.tags?t.tags.map((t=>{var e;return null===(e=this.options.tagColorMap)||void 0===e?void 0:e[t]})).find((t=>void 0!==t)):this.options.defaultColor;return t.color||e},this.selectedNode=void 0,this.nodes=[],this.dependencies={relations:[],hasRelatedSourceOfOtherKinds:!1},this.originalData={name:t.name,color:t.color,nodes:t.nodes||[],relations:t.relations||[]},this.allNodesLoaded=!i,this.nodesByKinds={},this.title=void 0,this.options={noTag:"Others",noTagSuffixCharacter:"…",relationDefaultWidth:15,defaultColor:"orange",tagColorMap:{},kinds:[],showRelatedKinds:!1,selectAndFilter:!0},this.setOptions(e)}initialize(){this.initializeSortRelations(),this.initializeRelationsInfo(),this.sortNodes(this.nodes)}resetColors(){if(this.options.tagColorMap){const t=Object.keys(this.options.tagColorMap);this.nodes.forEach((e=>{(t.some((t=>{var i;return null===(i=e.tags)||void 0===i?void 0:i.includes(t)}))||e.color===this.options.defaultColor)&&delete e.color}))}else this.nodes.forEach((t=>delete t.color))}setOptions(t){this.resetColors(),this.options=Object.assign(Object.assign({},this.options),t);const e=this.selectedNode;this.initialize(),this.selectedNode=void 0,this.selectNode(e)}appendData(t,e){this.selectedNode=void 0,this.mergeData(this.originalData,t),this.initialize(),this.selectNode(e)}getNodes(){return this.nodes||[]}getNodesByKind(t){var e;return null!==(e=this.nodesByKinds[t])&&void 0!==e?e:[]}getRelations(){return this.dependencies.relations||[]}getKinds(){var t,e;const i=Object.keys(this.nodesByKinds);return(null===(e=null===(t=this.options)||void 0===t?void 0:t.kinds)||void 0===e?void 0:e.length)>0?this.options.kinds.filter((t=>i.includes(t.name))):i.map((t=>({name:t})))}getTitle(){return this.title}setTitle(t){this.title=t?{title:t.title,name:t.name,color:t.color}:void 0}getSelectedNode(){return this.selectedNode}selectNode(t){const e=t=>{const e={};return t.forEach((t=>{e[t.kind]||(e[t.kind]=[]),e[t.kind].push(t)})),e};if(t){if(!t.kind||!t.name)throw new Error("Node must have kind and name");if(this.selectedNode&&t.name===this.selectedNode.name&&t.kind===this.selectedNode.kind)return this.selectedNode;if(this.selectedNode=this.originalData.nodes.find((e=>e.name===t.name&&e.kind===t.kind)),this.selectedNode){const t=this.options.kinds.find((t=>{var e;return t.name===(null===(e=this.selectedNode)||void 0===e?void 0:e.kind)}));(null==t?void 0:t.includeAlternative)?this.selectedNode.hasRelatedSourceOfOtherKinds=!0:delete this.selectedNode.hasRelatedSourceOfOtherKinds,this.selectedNode.hasRelatedSourceOfOtherKinds=!!(null==t?void 0:t.includeAlternative),this.options.selectAndFilter&&(this.options.showRelatedKinds?this.dependencies=this.filterDependencies(this.selectedNode,t):this.dependencies=this.filterDependencies(this.selectedNode),this.nodes=this.filterNodes(this.dependencies.relations),this.nodes.forEach((t=>{t.hasRelatedSourceOfSameKind=!!this.dependencies.relations.find((e=>e.target.kind===t.kind&&e.target.name===t.name&&e.source.kind===t.kind))})))}else this.nodes=[];this.nodesByKinds=e(this.nodes)}else this.nodes=this.originalData.nodes,this.dependencies.relations=this.originalData.relations||[],this.nodesByKinds=e(this.nodes),this.selectedNode=void 0;return this.sortNodes(this.nodes),this.selectedNode}sortNodesAlpabetically(t){const e=(this.options.noTag||"")+this.options.noTagSuffixCharacter;t.sort(((t,i)=>t.name===e&&i.name!==e?1:t.name!==e&&i.name===e?-1:0))}sortNodes(t){this.options.noTag,this.options.noTagSuffixCharacter;const e=this.getSelectedNode();if(!e)return void this.sortNodesAlpabetically(this.getNodes());let i=[];const n=this.options.kinds.findIndex((t=>t.name===(null==e?void 0:e.kind)));for(let t=n;t<this.options.kinds.length;t++){const n=this.options.kinds[t],s=this.nodesByKinds[n.name];s&&(this.sortNodesOfKind(n,s,i,e),i=s)}const s=this.options.kinds[n];i=this.nodesByKinds[s.name];for(let t=n-1;t>=0;t--){const n=this.options.kinds[t],s=this.nodesByKinds[n.name];s&&(this.sortNodesOfKind(n,s,i,e),i=s)}this.sortRelations()}sortNodesOfKind(t,e,i,n){if(t.name===(null==n?void 0:n.kind)){const i=this.getRelations(),s=i.filter((e=>e.source.name===n.name&&e.source.kind===t.name&&e.target.kind===t.name)).map((t=>t.target.name)),o=i.filter((e=>e.target.name===n.name&&e.target.kind===t.name&&e.source.kind===t.name)).map((t=>t.source.name));e.sort(((t,e)=>{const i=t=>{if(o.length>0){if(o.includes(t.name))return 1;if(t.name===n.name)return 2}else{if(t.name===n.name)return 1;if(s.includes(t.name))return 2}return 3},a=i(t),r=i(e);return a!==r?a-r:t.name.localeCompare(e.name)}))}else{const t=this.getRelations();e.sort(((e,n)=>{const s=t.filter((t=>t.target.name===e.name&&t.target.kind===e.kind)),o=t.filter((t=>t.target.name===n.name&&t.target.kind===n.kind)),a=i.findIndex((t=>s.some((e=>e.source.name===t.name)))),r=i.findIndex((t=>o.some((e=>e.source.name===t.name))));return-1!==a||-1!==r?a===r?e.name.localeCompare(n.name):r>a?-1:1:e.name.localeCompare(n.name)}))}}sortRelations(){const t={},e=1e5;Object.keys(this.nodesByKinds).forEach((i=>{let n=e;this.nodesByKinds[i].forEach((e=>{t[i+"::"+e.name]=n++}))}));const i=this.getRelations();null==i||i.sort(((i,n)=>{var s,o,a,r;const d=`${i.source.kind}::${i.source.name}`,l=`${n.source.kind}::${n.source.name}`,h=`${i.target.kind}::${i.target.name}`,c=`${n.target.kind}::${n.target.name}`,u=null!==(s=t[d])&&void 0!==s?s:Number.MAX_SAFE_INTEGER,m=null!==(o=t[l])&&void 0!==o?o:Number.MAX_SAFE_INTEGER,g=null!==(a=t[h])&&void 0!==a?a:Number.MAX_SAFE_INTEGER,p=null!==(r=t[c])&&void 0!==r?r:Number.MAX_SAFE_INTEGER;return u*e+g-(m*e+p)}))}initializeSortRelations(){var t;null===(t=this.originalData.relations)||void 0===t||t.sort(((t,e)=>t.source.kind!==e.source.kind?t.source.kind.localeCompare(e.source.kind):t.source.name.localeCompare(e.source.name))).sort(((t,e)=>t.source.kind===e.source.kind&&t.source.name===e.source.name?t.target.kind!==e.target.kind?t.target.kind.localeCompare(e.target.kind):t.target.name.localeCompare(e.target.name):0))}initializeRelationsInfo(){var t;const e={};null===(t=this.originalData.relations)||void 0===t||t.forEach((t=>{const i=t.source.kind+"::"+t.source.name;e[i]||(e[i]={sourceCount:0,targetCount:0,sameKindCount:0}),t.source.kind===t.target.kind?e[i].sameKindCount++:e[i].sourceCount++;const n=t.target.kind+"::"+t.target.name;e[n]||(e[n]={sourceCount:0,targetCount:0,sameKindCount:0}),e[n].targetCount++})),this.originalData.nodes.forEach((t=>{var i;const n=e[t.kind+"::"+t.name];t.color=this.getNodeTagColor(t),t.cardinality=n,t.targetCount&&(t.cardinality={targetCount:t.targetCount,sameKindCount:0}),t.sourceCount&&(t.cardinality=Object.assign(null!==(i=t.cardinality)&&void 0!==i?i:{},{sourceCount:t.sourceCount,sameKindCount:0}))}))}getIndexByKind(t,e){var i,n;const s=null===(n=null===(i=this.options)||void 0===i?void 0:i.kinds)||void 0===n?void 0:n.findIndex((e=>e.name===t));if(s>-1){let t=s+e;return t<0||t>=this.options.kinds.length?-1:t}return-1}searchByName(t){if(!t.kind||!t.name)throw new Error("Filter criteria is empty");return this.originalData.nodes.filter((e=>e.kind===t.kind&&e.name.includes(t.name)))}findByName(t,e){return e.find((e=>e.name===t))}filterDependencies(t,e){let i=[];const n=this.options.kinds.map((t=>t.name));let s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&e.source.name===t.name&&(!(n.length>0)||n.includes(e.target.kind))));if(0==s.length){const e=this.originalData.relations.filter((e=>e.target.kind===t.kind&&e.target.name===t.name&&(!(n.length>0)||n.includes(e.source.kind)))),i=e.map((t=>t.source.name));s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&i.includes(e.source.name))),s.push(...e)}const o=s?[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],a=this.targetTargetRelations(t.kind,n,o);if(null==e?void 0:e.includeAlternative){const t=[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))];i=this.originalData.relations.filter((i=>t.includes(`${i.target.kind}::${i.target.name}`)&&e.name===i.source.kind))}const r=this.originalData.relations.filter((e=>(!(n.length>0)||n.includes(e.target.kind))&&e.target.kind===t.kind&&e.target.name===t.name)),d=r?[...new Set(r.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],l=this.originalData.relations.filter((t=>(!(n.length>0)||n.includes(t.target.kind))&&d.includes(`${t.target.kind}::${t.target.name}`))),h=[...new Set([...s,...a,...l,...i,...r].map((t=>JSON.stringify(t))))].map((t=>JSON.parse(t)));return t.hasRelationsOfSameKinds=!!h.find((e=>e.source.kind===t.kind||e.target.kind===t.kind)),{relations:h,hasRelatedSourceOfOtherKinds:i.length>0}}targetTargetRelations(t,e,i){return this.options.showSameKindsOnNonSelected?this.originalData.relations.filter((t=>(!(e.length>0)||e.includes(t.target.kind))&&i.includes(t.source.kind+"::"+t.source.name))):this.originalData.relations.filter((n=>(n.target.kind!==n.source.kind||n.source.kind===t)&&(!(e.length>0)||e.includes(n.target.kind))&&i.includes(n.source.kind+"::"+n.source.name)))}filterNodes(t){const e=t.flatMap((t=>`${t.target.kind}::${t.target.name}`)),i=t.flatMap((t=>`${t.source.kind}::${t.source.name}`));this.selectedNode&&i.push(`${this.selectedNode.kind}::${this.selectedNode.name}`);const n=[...new Set(e.concat(i))];return this.originalData.nodes.filter((t=>n.includes(`${t.kind}::${t.name}`)))}mergeData(t,e){return e.nodes.forEach((e=>{const i=t.nodes.findIndex((t=>t.kind===e.kind&&t.name===e.name));if(-1!==i){const n=t.nodes[i];t.relations.filter((t=>n.kind===t.source.kind&&n.name===t.source.name||n.kind===t.target.kind&&n.name===t.target.name)).forEach((e=>{const i=t.relations.indexOf(e);-1!==i&&t.relations.splice(i,1)})),t.nodes[i]=e}else t.nodes.push(e)})),e.relations.forEach((e=>{-1===t.relations.findIndex((t=>t.source.kind===e.source.kind&&t.source.name===e.source.name&&t.target.kind===e.target.kind&&t.target.name===e.target.name))&&t.relations.push(e)})),t}}class s{constructor(){this.listeners=new Map}subscribe(t,e){var i;this.listeners.has(t)||this.listeners.set(t,[]),null===(i=this.listeners.get(t))||void 0===i||i.push(e)}unsubscribe(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t),n=i.indexOf(e);-1!==n&&i.splice(n,1)}}dispatchEvent(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t).slice();for(const t of i)t(e)}}}const o=class{constructor(t,e){this.SVG_NS="http://www.w3.org/2000/svg",this.svgElement=t,this.className={NODE_TYPE_TITLE:"node-kind-title",NODE_TITLE:"node-title",RELATION:"relation",CARDINALITY:"cardinality",SELECTED:"selected"},this.options={nodeWidth:10,nodeLineHeight:18,marginX:15,marginY:5,leftX:15,topY:10,nodeMarginY:10,nodeColumnWidth:300,defaultNodeColor:"gray",renderKindAsColums:!0,trafficLog10Factor:12,relationDefaultWidth:15,relation:{selectedOpacity:.2,analyticsOpacity:.2,opacity:.2,environment:{nonPROD:{dashArray:"10,1"}},sameKindIndentation:20},selectedNode:{dropShadow:!1,borderColor:"#ff1010",hoverOpacity:.2},truncateText:{defaultFontSizeAndFamily:"16px Arial",ellipseCharacter:"…"},rootCharacter:"⌂"},e&&this.setOptions(e),this.calculatedHeight=0,this.nodePositions={},this.eventHandler=new s,this.contextMenuCallbackFunction=void 0,this.selectedNodePositionY=-1,this.truncateText=this.createTruncateText()}setOptions(t){t.nodeColumnWidth=Number(t.nodeColumnWidth),this.options=this.deepMerge(this.options,t),this.render()}setData(t){this.chartData!==t&&(this.chartData=t,this.render(),this.eventHandler.dispatchEvent("selectionChanged",{node:this.chartData.getSelectedNode(),position:{y:0}}))}getData(){return this.chartData}addSelectionChangedListeners(t){var e;"function"==typeof t&&(this.eventHandler.subscribe("selectionChanged",t),t({node:null===(e=this.chartData)||void 0===e?void 0:e.getSelectedNode(),position:{y:0}}))}addContextMenuListeners(t){"function"==typeof t&&(this.contextMenuCallbackFunction=t)}getDirectTargetNodesOf(t){var e,i;return null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getRelations().filter((e=>e.source.kind===t.kind&&e.source.name===t.name)).map((t=>t.target)))&&void 0!==i?i:[]}getDirectSourceNodesOf(t){var e,i;return null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getRelations().filter((e=>e.target.kind===t.kind&&e.target.name===t.name)).map((t=>t.source)))&&void 0!==i?i:[]}createTruncateText(){const t=document.createElement("canvas").getContext("2d"),e=new Map,i=this.options.truncateText.ellipseCharacter,n=this.options.truncateText.defaultFontSizeAndFamily;return function(s,o,a=n){const r=`${s}-${o}-${a}`;if(e.has(r))return e.get(r);if(!t)return s;if(t.font=a,t.measureText(s).width<=o)return e.set(r,s),s;let d=s;for(;t.measureText(d+i).width>o;)d=d.slice(0,-1);const l=d+i;return e.set(r,l),l}}resetSvg(){this.calculatedHeight=0,this.svgElement.innerHTML='\n      <defs>\n        <filter id="dropshadow">\n          <feGaussianBlur stdDeviation="0.4" />\n        </filter>\n      </defs>\n    '}updateHeight(){var t,e,i;const n=((null!==(t=this.options.nodeColumnWidth)&&void 0!==t?t:0)+(null!==(e=this.options.nodeWidth)&&void 0!==e?e:0))*Math.max(1,(null===(i=this.chartData)||void 0===i?void 0:i.getKinds().length)||0)+2*this.options.marginX;this.svgElement.setAttribute("height",this.calculatedHeight.toString()),this.svgElement.setAttribute("width",n.toString())}renderElipsisMenu(t,e,i){const n=document.createElementNS(this.SVG_NS,"g");n.setAttribute("id","ellipsisMenu"),n.setAttribute("style","cursor: pointer;"),n.setAttribute("transform",`translate(${t+2.5}, ${e})`);const s=this.createRect(-2.5,0,this.options.nodeWidth,22,"black","0.2");s.setAttribute("rx","5"),s.setAttribute("ry","5"),n.appendChild(s);for(let t=5;t<=15;t+=5){const e=this.createCircle(2.5,t,2,"white");n.appendChild(e)}return n.addEventListener("click",(t=>{this.contextMenuCallbackFunction&&(this.contextMenuCallbackFunction(t,i),t.stopPropagation())})),n}deepMerge(t,e){if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return e;for(const i of Object.keys(e))Array.isArray(e[i])?t[i]=e[i].slice():"object"==typeof e[i]&&null!==e[i]?(t[i]||(t[i]={}),this.deepMerge(t[i],e[i])):t[i]=e[i];return t}renderNodes(t,e,i,n,s,o){var a,r,d,l;const h=document.createElementNS(this.SVG_NS,"g");let c=this.options.topY;if(this.options.renderKindAsColums){const t=(null==n?void 0:n.title)||(null===(r=null===(a=this.chartData)||void 0===a?void 0:a.getTitle())||void 0===r?void 0:r.name),i=(null==n?void 0:n.color)||(null===(l=null===(d=this.chartData)||void 0===d?void 0:d.getTitle())||void 0===l?void 0:l.color)||this.options.defaultNodeColor,s=e+this.options.nodeWidth/2,o=this.options.topY+this.options.marginY+this.options.nodeWidth/2;let u=e+this.options.nodeWidth+this.options.nodeMarginY/2;const m=this.options.topY+this.options.marginY+this.options.nodeWidth;let g="";if(null==n?void 0:n.color){const t=this.createCircle(s,o,5,i);h.appendChild(t)}else g="| ",u-=13;const p=this.createSvgText(g+t,[this.className.NODE_TYPE_TITLE]);p.setAttribute("x",u.toString()),p.setAttribute("y",m.toString()),h.appendChild(p),c+=25}return t.forEach(((t,n)=>{var a;const r=t.sourceRelations||{height:0,count:0},d=t.targetRelations||{height:0,count:0},l=(1+(t.subtitle?1:0)+((null===(a=t.tags)||void 0===a?void 0:a.length)?1:0)+(this.options.renderKindAsColums?0:1))*this.options.nodeLineHeight+this.options.marginY;t.textLinesHeight=l;const u=!(!i||i.name!==t.name||i.kind!==t.kind),m=2*this.options.marginY+Math.max(l,l+(r.height>0?r.height+12:0),d.height>0?d.height+12:0),g=this.options.marginY+c,p=t.color||this.options.defaultNodeColor;let v=e,f=this.options.nodeColumnWidth;u&&(this.selectedNodePositionY=g),t.hasRelatedSourceOfSameKind&&(v+=this.options.relation.sameKindIndentation,f-=this.options.relation.sameKindIndentation);const S=document.createElementNS(this.SVG_NS,"g"),k=this.createRect(v,g,f,m,p,"0"),b=this.createRect(v,g,this.options.nodeWidth,m,p);if(u){const t=this.createRect(v-2,g-2,this.options.nodeWidth+4,m+4,"none");t.setAttribute("rx","6"),t.setAttribute("ry","6"),this.options.selectedNode.dropShadow?(t.setAttribute("fill","black"),t.setAttribute("filter","url(#dropshadow)"),t.setAttribute("opacity","0.2")):this.options.selectedNode.borderColor&&(t.setAttribute("stroke-width","2"),t.setAttribute("stroke",this.options.selectedNode.borderColor),t.setAttribute("fill","none"),t.setAttribute("opacity","1")),S.appendChild(t)}if(S.appendChild(b),k.style.cursor="pointer",S.appendChild(k),t.cardinality||t.targetCount||t.sourceCount){const e=!!(null==s?void 0:s.find((e=>t.name===e.name&&t.kind===e.kind))),i=!!(null==o?void 0:o.find((e=>t.name===e.name&&t.kind===e.kind)));this.appendCardinalityText(S,t,v,g,m,p,u,e,i)}const N=this.createSvgText("",[this.className.NODE_TITLE,u?this.className.SELECTED:""]);N.setAttribute("x",String(v+this.options.marginX)),N.setAttribute("y",g.toString());this.createTextLines(t,this.options.nodeColumnWidth-this.options.nodeWidth).forEach(((t,e)=>{const i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("x",String(v+this.options.marginX)),i.setAttribute("dy","1.2em"),i.textContent=t.text,i.classList.add(t.class),N.appendChild(i)})),S.appendChild(N),(null==t?void 0:t.placeHolder)||this.addHoverAndClickEvents(S,k,t),h.appendChild(S),u&&!(null==t?void 0:t.placeHolder)&&this.contextMenuCallbackFunction&&h.appendChild(this.renderElipsisMenu(v,g,t)),this.nodePositions[t.kind+"::"+t.name]={node:t,x:v,y:g,index:n,sourceY:g+this.options.marginY,targetY:g,height:m,textLinesHeight:t.textLinesHeight,sourceIndex:0,targetIndex:0,accumulatedSourceY:0,accumulatedTargetY:0},c+=m+this.options.nodeMarginY})),this.calculatedHeight=Math.max(this.calculatedHeight,c+2*this.options.nodeMarginY),h}createCircle(t,e,i,n){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("cx",t.toString()),s.setAttribute("cy",e.toString()),s.setAttribute("r",i.toString()),s.setAttribute("fill",n),s}createRect(t,e,i,n,s,o="1"){const a=document.createElementNS(this.SVG_NS,"rect");return a.setAttribute("x",t.toString()),a.setAttribute("y",e.toString()),a.setAttribute("width",i.toString()),a.setAttribute("height",n.toString()),a.setAttribute("rx","5"),a.setAttribute("ry","5"),a.setAttribute("fill",s),a.setAttribute("opacity",o),a}appendCardinalityText(t,e,i,n,s,o,a,r,d){var l,h,c,u,m,g,p,v,f,S,k,b;if(null!==(h=null===(l=e.cardinality)||void 0===l?void 0:l.sourceCount)&&void 0!==h&&h){const d=(null===(c=this.chartData)||void 0===c?void 0:c.allNodesLoaded)||a||r,l=(null===(u=e.cardinality)||void 0===u?void 0:u.sourceCount)+(d?"":"..*")+((null!==(g=null===(m=e.cardinality)||void 0===m?void 0:m.sameKindCount)&&void 0!==g?g:0)>0?"+"+(null!==(v=null===(p=e.cardinality)||void 0===p?void 0:p.sameKindCount)&&void 0!==v?v:0):""),h=this.createSvgText("- "+l,[this.className.CARDINALITY,a?this.className.SELECTED:""]);h.setAttribute("x",String(i+this.options.marginX-6)),h.setAttribute("y",String(n+s-2)),h.setAttribute("fill",o),t.appendChild(h)}if(null!==(S=null===(f=e.cardinality)||void 0===f?void 0:f.targetCount)&&void 0!==S&&S){const r=(null===(k=this.chartData)||void 0===k?void 0:k.allNodesLoaded)||a||d,l=(null===(b=e.cardinality)||void 0===b?void 0:b.targetCount)+(r?"":"..*"),h=this.createSvgText(l+" -",[this.className.CARDINALITY,a?this.className.SELECTED:""]);h.setAttribute("x",String(i+this.options.marginX-14)),h.setAttribute("y",String(n+s-2)),h.setAttribute("fill",o),h.setAttribute("text-anchor","end"),t.appendChild(h)}}createTextLines(t,e){const i=[{text:this.truncateText?this.truncateText(t.title?t.title:t.name,e):t.title?t.title:t.name,class:"headline"}];if(t.subtitle){const n=this.truncateText?this.truncateText(t.subtitle,e):t.subtitle;i.splice(1,0,{text:n,class:"subtitle"})}if(t.tags){const n=this.truncateText?this.truncateText(t.tags.join(", "),e):t.tags.join(", ");i.push({text:n,class:"description"})}return this.options.renderKindAsColums||i.push({text:t.kind.charAt(0).toUpperCase()+t.kind.slice(1),class:"description"}),i}addHoverAndClickEvents(t,e,i){t.addEventListener("click",(t=>{var e;null===(e=this.chartData)||void 0===e||e.selectNode(i),this.render(),this.eventHandler.dispatchEvent("selectionChanged",{node:i,position:{y:this.selectedNodePositionY}})})),t.addEventListener("mouseenter",(t=>{e.setAttribute("opacity",this.options.selectedNode.hoverOpacity.toString())})),t.addEventListener("mouseleave",(t=>{e.setAttribute("opacity","0")}))}createSvgText(t,e){const i=document.createElementNS(this.SVG_NS,"text");return i.classList.add(...e.filter((t=>t))),i.textContent=t,i}renderRelations(t,e){const{name:i,kind:n,color:s}=e||{},o=s||this.options.defaultNodeColor,a=JSON.parse(JSON.stringify(this.nodePositions)),r=document.createElementNS(this.SVG_NS,"g"),d=document.createElementNS(this.SVG_NS,"g");null==t||t.forEach((t=>{var s,l,h,c,u,m;const g=a[t.source.kind+"::"+t.source.name],p=a[t.target.kind+"::"+t.target.name];if(!p||!g)return;const v=g.node.color||o,f=t.source.kind===t.target.kind,S=f?0:this.calculateGap(g.sourceIndex++),k=null!==(s=g.textLinesHeight)&&void 0!==s?s:0;k>0&&(g.textLinesHeight=0),g.accumulatedSourceY=k+g.accumulatedSourceY+S;const b=f?0:this.calculateGap(p.targetIndex++);p.accumulatedTargetY=(null!==(l=p.accumulatedTargetY)&&void 0!==l?l:0)+b;const{source:N,target:C,height:y}=t,w=g.x+this.options.nodeWidth,A=g.sourceY+(y||0)/2+g.accumulatedSourceY,x=this.options.marginY+p.targetY+(y||0)/2+p.accumulatedTargetY,E=(g.x+this.options.nodeWidth+p.x)/2;let T,D=this.options.relation.opacity,V=y;if((t.source.kind===n&&t.source.name===i||t.target.kind===n&&t.target.name===i)&&(D+=this.options.relation.selectedOpacity),N.kind===C.kind){if(g.index<p.index){const t=g.x+this.options.nodeWidth/2,e=g.y+g.height,i=p.x+this.options.nodeWidth/2,n=p.y+p.height/2;T=`M${t},${e} C${t},${n} ${t},${n} ${i},${n}`}else{const t=g.x+this.options.nodeWidth/2,e=g.y+g.height/2,i=p.x+this.options.nodeWidth/2;T=`M${i},${p.y+p.height} C${i},${e} ${i},${e} ${t},${e}`}D=.8,V=2}else T=`M${w},${A} C${E},${A} ${E},${x} ${p.x},${x}`;const $=document.createElementNS("http://www.w3.org/2000/svg","path");let M;if($.setAttribute("d",T),$.setAttribute("fill","none"),$.setAttribute("stroke-width",String(V||0)),$.setAttribute("stroke",v),d.appendChild($),M);else{M=t.analytics;t.target.kind===(null==e?void 0:e.kind)||(t.source.kind,null==e||e.kind)}if(null!==(h=null==M?void 0:M.traffic)&&void 0!==h&&h){const t=this.createSvgText("",[this.className.RELATION]);t.setAttribute("x",String(p.x-this.options.marginY)),t.setAttribute("y",String(p.targetY+(y||0)+b)),t.setAttribute("text-anchor","end");const e=document.createElementNS(this.SVG_NS,"tspan");if(e.textContent=(null==M?void 0:M.environment)||"",t.appendChild(e),(null==M?void 0:M.environment)&&this.options.relation.environment[null==M?void 0:M.environment]&&$.setAttribute("stroke-dasharray",this.options.relation.environment[M.environment].dashArray),null!==(c=null==M?void 0:M.errors)&&void 0!==c&&c){const e=100/(null!==(u=null==M?void 0:M.traffic)&&void 0!==u?u:0)*(null!==(m=null==M?void 0:M.errors)&&void 0!==m?m:0),i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("fill","red"),i.textContent=" "+(0==e?"(<0.01%)":"("+e.toFixed(2).toLocaleString()+"%)"),t.appendChild(i)}const i=document.createElementNS(this.SVG_NS,"tspan");i.textContent=" "+(null==M?void 0:M.traffic.toLocaleString()),t.appendChild(i),r.appendChild(t),D+=this.options.relation.analyticsOpacity}else N.kind,C.kind;g.sourceY+=null!=y?y:0,p.targetY+=null!=y?y:0,$.setAttribute("opacity",String(D))})),this.svgElement.appendChild(d),this.svgElement.appendChild(r)}render(){var t,e,i,n,s,o,a,r,d;if(!this.chartData)return;const l=null===(t=this.chartData)||void 0===t?void 0:t.getSelectedNode();this.resetSvg(),this.updateRelationWeights(null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getNodes())&&void 0!==i?i:[],null!==(s=null===(n=this.chartData)||void 0===n?void 0:n.getRelations())&&void 0!==s?s:[],l);let h=0;const c=this.options.nodeColumnWidth+this.options.nodeWidth,u=null===(o=this.chartData)||void 0===o?void 0:o.getKinds();this.selectedNodePositionY=-1;const m=document.createElementNS(this.SVG_NS,"g");if(u&&u.length>0){const t=l?this.getDirectTargetNodesOf(l):[],e=l?this.getDirectSourceNodesOf(l):[];u.forEach((i=>{var n,s;m.appendChild(this.renderNodes(null!==(s=null===(n=this.chartData)||void 0===n?void 0:n.getNodesByKind(i.name))&&void 0!==s?s:[],this.options.leftX+c*h++,l,i,t,e))}))}else m.appendChild(this.renderNodes(null!==(r=null===(a=this.chartData)||void 0===a?void 0:a.getNodes())&&void 0!==r?r:[],this.options.leftX+0));this.renderRelations(null===(d=this.chartData)||void 0===d?void 0:d.getRelations(),l),this.svgElement.appendChild(m),this.updateHeight()}updateRelationWeights(t,e,i){if(!e)return;const n=e.reduce(((t,e)=>{var i,n;const{source:s,target:o,analytics:a}=e;if(s.kind===o.kind)return e.height=0,t;const r=`s${s.kind}:${s.name}`,d=`t${o.kind}:${o.name}`,l=(null==a?void 0:a.traffic)&&a.traffic>0?Math.round(Math.log10(Math.max(a.traffic,2))*(null!==(i=this.options.trafficLog10Factor)&&void 0!==i?i:12)):null!==(n=this.options.relationDefaultWidth)&&void 0!==n?n:10;return e.height=l,t[r]||(t[r]={height:0,count:0}),t[d]||(t[d]={height:0,count:0}),t[r].height+=l+this.calculateGap(t[r].count),t[r].count+=1,t[d].height+=l+this.calculateGap(t[d].count),t[d].count+=1,t}),{});t.forEach((t=>{t.sourceRelations=n[`s${t.kind}:${t.name}`],t.targetRelations=n[`t${t.kind}:${t.name}`]}))}calculateGap(t){return Math.min(80,3*t)}};class a{constructor(t,e,i){this.mainViewHeight=0,this.mainViewWidth=0,this.mainViewScrollWidth=0,this.mainViewScrollHeight=0,this.scaleUnitY=1,this.scaleUnitX=1,this.drag=t=>{const e=this.minimapPane.getBoundingClientRect(),i=this.visibleSection.getBoundingClientRect();let n=t.clientX-e.left-i.width/2,s=t.clientY-e.top-i.height/2;n=Math.max(0,Math.min(n,e.width-i.width)),s=Math.max(0,Math.min(s,e.height-i.height));const o=s/((this.minimapPane.scrollHeight>this.minimapPane.clientHeight?e.height:this.miniMapSVG.getBoundingClientRect().height)-i.height),a=n/(e.width-i.width);this.mainView.scrollTop=o*(this.mainViewScrollHeight-this.mainViewHeight),this.mainView.scrollLeft=a*(this.mainViewScrollWidth-this.mainViewWidth)},this.endDrag=()=>{document.removeEventListener("mousemove",this.drag),document.removeEventListener("mouseup",this.endDrag)},this.mainView=i,this.container=e,this.visibleSection=this.createVisibleSection(),this.miniMapSVG=this.createMiniMapSVG(t.id),this.miniMapSVG.appendChild(this.visibleSection),this.minimapPane=this.createMinimapPane(),this.minimapPane.appendChild(this.miniMapSVG),this.container.appendChild(this.minimapPane),this.mainView.addEventListener("scroll",this.syncScroll.bind(this)),this.visibleSection.addEventListener("mousedown",this.startDrag.bind(this));const n=new ResizeObserver((()=>{this.initialize()}));n.observe(this.container),n.observe(this.mainView)}initialize(){this.mainViewHeight=this.mainView.clientHeight,this.mainViewWidth=this.mainView.clientWidth,this.mainViewScrollWidth=this.mainView.scrollWidth,this.mainViewScrollHeight=this.mainView.scrollHeight,this.visibleSection.setAttribute("width",this.mainViewWidth.toString()),this.visibleSection.setAttribute("height",this.mainViewHeight.toString()),this.miniMapSVG.setAttribute("viewBox",`0 0 ${this.mainViewScrollWidth} ${this.mainViewScrollHeight}`),this.mainView.scrollTop=0,this.mainView.scrollLeft=0,this.visibleSection.setAttribute("width",this.mainViewWidth.toString()),this.visibleSection.setAttribute("height",this.mainViewHeight.toString()),this.scaleUnitY=this.mainViewHeight===this.mainViewScrollHeight?1:-1/(this.mainViewHeight-this.mainViewScrollHeight),this.scaleUnitX=this.mainViewWidth===this.mainViewScrollWidth?1:-1/(this.mainViewWidth-this.mainViewScrollWidth),this.minimapPane.style.minHeight=`${this.mainViewHeight}px`,this.minimapPane.style.display="block";const t=Math.min(this.minimapPane.clientHeight,this.mainViewHeight);this.minimapPane.style.minHeight=`${t}px`,this.mainViewHeight===this.mainViewScrollHeight&&this.mainViewWidth===this.mainViewScrollWidth&&(this.minimapPane.style.display="none"),this.syncScroll()}createMiniMapSVG(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("class","preview-svg");const i=document.createElementNS("http://www.w3.org/2000/svg","use");return i.setAttribute("href",`#${t}`),i.setAttribute("pointer-events","none"),e.appendChild(i),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="auto",e}createMinimapPane(){const t=document.createElement("div");return t.className="minimap-pane",t.style.overflow="hidden",t.style.position="absolute",t.style.right="0",t.style.top="0",t}createVisibleSection(){const t=document.createElementNS("http://www.w3.org/2000/svg","rect");return t.setAttribute("class","minimap-visible-section"),t.setAttribute("x","0"),t.setAttribute("y","0"),t}syncScroll(){const t=this.scaleUnitY*this.mainView.scrollTop,e=this.scaleUnitX*this.mainView.scrollLeft;this.minimapPane.scrollTop=(this.minimapPane.scrollHeight-this.minimapPane.clientHeight)*t,this.minimapPane.scrollLeft=(this.minimapPane.scrollWidth-this.minimapPane.clientWidth)*e;const i=(this.mainViewScrollHeight-this.mainViewHeight)*t,n=(this.mainViewScrollWidth-this.mainViewWidth)*e;this.visibleSection.setAttribute("y",i.toString()),this.visibleSection.setAttribute("x",n.toString())}startDrag(t){t.preventDefault(),document.addEventListener("mousemove",this.drag),document.addEventListener("mouseup",this.endDrag)}}return window.SankeyChart=o,window.SankeyChartData=n,window.EventHandler=s,window.MiniMap=a,i})()));