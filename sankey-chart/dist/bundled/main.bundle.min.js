!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SankeyChartLibrary=e():t.SankeyChartLibrary=e()}(this,(()=>(()=>{"use strict";var t,e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};e.r(i),e.d(i,{EventHandler:()=>s,IncludeKind:()=>t,Preview:()=>a,SankeyChart:()=>o,SankeyChartData:()=>n}),function(t){t.WITH_SAME_TARGET="WITH_SAME_TARGET"}(t||(t={}));class n{constructor(t,e){this.getNodeTagColor=t=>{const e=t.tags?t.tags.map((t=>{var e;return null===(e=this.options.tagColorMap)||void 0===e?void 0:e[t]})).find((t=>void 0!==t)):this.options.defaultColor;return t.color||e},this.selectedNode=void 0,this.nodes=[],this.dependencies={relations:[],hasRelatedSourceOfOtherKinds:!1},this.originalData={name:t.name,color:t.color,nodes:t.nodes||[],relations:t.relations||[]},this.nodesByKinds={},this.title=void 0,this.options={noTag:"Others",noTagSuffixCharacter:"…",relationDefaultWidth:15,defaultColor:"orange",tagColorMap:{},kinds:[],showRelatedKinds:!1,selectAndFilter:!0},this.setOptions(e)}initialize(){this.initializeSortRelations(),this.initializeRelationsInfo(),this.sortNodes(this.nodes)}resetColors(){if(this.options.tagColorMap){const t=Object.keys(this.options.tagColorMap);this.nodes.forEach((e=>{t.some((t=>{var i;return null===(i=e.tags)||void 0===i?void 0:i.includes(t)}))&&delete e.color}))}else this.nodes.forEach((t=>delete t.color))}setOptions(t){this.resetColors(),this.options=Object.assign(Object.assign({},this.options),t);const e=this.selectedNode;this.initialize(),this.selectedNode=void 0,this.selectNode(e)}appendData(t,e){this.selectedNode=void 0,this.mergeData(this.originalData,t),this.initialize(),this.selectNode(e)}getNodes(){return this.nodes||[]}getNodesByKind(t){var e;return null!==(e=this.nodesByKinds[t])&&void 0!==e?e:[]}getRelations(){return this.dependencies.relations||[]}getKinds(){var t,e;const i=Object.keys(this.nodesByKinds);return(null===(e=null===(t=this.options)||void 0===t?void 0:t.kinds)||void 0===e?void 0:e.length)>0?this.options.kinds.filter((t=>i.includes(t.name))):i.map((t=>({name:t})))}getTitle(){return this.title}setTitle(t){this.title=t?{title:t.title,name:t.name,color:t.color}:void 0}getSelectedNode(){return this.selectedNode}selectNode(t){const e=t=>{const e={};return t.forEach((t=>{e[t.kind]||(e[t.kind]=[]),e[t.kind].push(t)})),e};if(t){if(!t.kind||!t.name)throw new Error("Node must have kind and name");if(this.selectedNode&&t.name===this.selectedNode.name&&t.kind===this.selectedNode.kind)return this.selectedNode;if(this.selectedNode=this.originalData.nodes.find((e=>e.name===t.name&&e.kind===t.kind)),this.selectedNode){const t=this.options.kinds.find((t=>{var e;return t.name===(null===(e=this.selectedNode)||void 0===e?void 0:e.kind)}));(null==t?void 0:t.includeAlternative)?this.selectedNode.hasRelatedSourceOfOtherKinds=!0:delete this.selectedNode.hasRelatedSourceOfOtherKinds,this.selectedNode.hasRelatedSourceOfOtherKinds=!!(null==t?void 0:t.includeAlternative),this.options.selectAndFilter&&(this.options.showRelatedKinds?this.dependencies=this.filterDependencies(this.selectedNode,t):this.dependencies=this.filterDependencies(this.selectedNode),this.nodes=this.filterNodes(this.dependencies.relations),this.nodes.forEach((t=>{t.hasRelatedSourceOfSameKind=!!this.dependencies.relations.find((e=>e.target.kind===t.kind&&e.target.name===t.name&&e.source.kind===t.kind))})))}else this.nodes=[];this.nodesByKinds=e(this.nodes)}else this.nodes=this.originalData.nodes,this.dependencies.relations=this.originalData.relations||[],this.nodesByKinds=e(this.nodes),this.selectedNode=void 0;return this.sortNodes(this.nodes),this.selectedNode}sortNodesAlpabetically(t){const e=(this.options.noTag||"")+this.options.noTagSuffixCharacter;t.sort(((t,i)=>t.name===e&&i.name!==e?1:t.name!==e&&i.name===e?-1:0))}sortNodes(t){this.options.noTag,this.options.noTagSuffixCharacter;const e=this.getSelectedNode();if(!e)return void this.sortNodesAlpabetically(this.getNodes());let i=[];const n=this.options.kinds.findIndex((t=>t.name===(null==e?void 0:e.kind)));for(let t=n;t<this.options.kinds.length;t++){const n=this.options.kinds[t],s=this.nodesByKinds[n.name];s&&(this.sortNodesOfKind(n,s,i,e),i=s)}const s=this.options.kinds[n];i=this.nodesByKinds[s.name];for(let t=n-1;t>=0;t--){const n=this.options.kinds[t],s=this.nodesByKinds[n.name];s&&(this.sortNodesOfKind(n,s,i,e),i=s)}this.sortRelations()}sortNodesOfKind(t,e,i,n){if(t.name===(null==n?void 0:n.kind))e.sort(((t,e)=>t.name===n.name?-1:e.name===n.name?1:t.name.localeCompare(e.name)));else{const t=this.getRelations();e.sort(((e,n)=>{const s=t.filter((t=>t.target.name===e.name&&t.target.kind===e.kind)),o=t.filter((t=>t.target.name===n.name&&t.target.kind===n.kind)),a=i.findIndex((t=>s.some((e=>e.source.name===t.name)))),r=i.findIndex((t=>o.some((e=>e.source.name===t.name))));return-1!==a||-1!==r?a===r?e.name.localeCompare(n.name):r>a?-1:1:e.name.localeCompare(n.name)}))}}sortRelations(){const t={},e=1e5;Object.keys(this.nodesByKinds).forEach((i=>{let n=e;this.nodesByKinds[i].forEach((e=>{t[i+"::"+e.name]=n++}))}));const i=this.getRelations();null==i||i.sort(((i,n)=>{var s,o,a,r;const d=`${i.source.kind}::${i.source.name}`,l=`${n.source.kind}::${n.source.name}`,h=`${i.target.kind}::${i.target.name}`,c=`${n.target.kind}::${n.target.name}`,u=null!==(s=t[d])&&void 0!==s?s:Number.MAX_SAFE_INTEGER,g=null!==(o=t[l])&&void 0!==o?o:Number.MAX_SAFE_INTEGER,p=null!==(a=t[h])&&void 0!==a?a:Number.MAX_SAFE_INTEGER,m=null!==(r=t[c])&&void 0!==r?r:Number.MAX_SAFE_INTEGER;return u*e+p-(g*e+m)}))}initializeSortRelations(){var t;null===(t=this.originalData.relations)||void 0===t||t.sort(((t,e)=>t.source.kind!==e.source.kind?t.source.kind.localeCompare(e.source.kind):t.source.name.localeCompare(e.source.name))).sort(((t,e)=>t.source.kind===e.source.kind&&t.source.name===e.source.name?t.target.kind!==e.target.kind?t.target.kind.localeCompare(e.target.kind):t.target.name.localeCompare(e.target.name):0))}initializeRelationsInfo(){var t;const e={};null===(t=this.originalData.relations)||void 0===t||t.forEach((t=>{const i=t.source.kind+"::"+t.source.name;e[i]||(e[i]={sourceCount:0,targetCount:0,refs:0}),t.source.kind===t.target.kind?e[i].refs++:e[i].sourceCount++;const n=t.target.kind+"::"+t.target.name;e[n]||(e[n]={sourceCount:0,targetCount:0,refs:0}),e[n].targetCount++}));const i=[];this.originalData.nodes.forEach((t=>{const n=e[t.kind+"::"+t.name];if(t.color=this.getNodeTagColor(t),t.targetCount||t.sourceCount){if(t.cardinality={sourceCount:t.sourceCount,targetCount:t.targetCount,fetchMore:!0,refs:0},t.sourceCount){delete t.sourceCount;const e=this.appendNextNode(t,-1);e&&i.push(e)}if(t.targetCount){delete t.targetCount;const e=this.appendNextNode(t,1);e&&i.push(e)}}else t.cardinality=n})),i.forEach((t=>{this.originalData.nodes.push(t)}))}getIndexByKind(t,e){var i,n;const s=null===(n=null===(i=this.options)||void 0===i?void 0:i.kinds)||void 0===n?void 0:n.findIndex((e=>e.name===t));if(s>-1){let t=s+e;return t<0||t>=this.options.kinds.length?-1:t}return-1}appendNextNode(t,e){const i=this.getIndexByKind(t.kind,e);if(i>-1){const n={kind:this.options.kinds[i].name,name:"…",placeHolder:!0},s=-1===e?{source:n,target:t}:{source:t,target:n};return this.originalData.relations.push(s),n}}searchByName(t){if(!t.kind||!t.name)throw new Error("Filter criteria is empty");return this.originalData.nodes.filter((e=>e.kind===t.kind&&e.name.includes(t.name)))}findByName(t,e){return e.find((e=>e.name===t))}filterDependencies(t,e){let i=[];const n=this.options.kinds.map((t=>t.name));let s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&e.source.name===t.name&&(!(n.length>0)||n.includes(e.target.kind))));if(0==s.length){const e=this.originalData.relations.filter((e=>e.target.kind===t.kind&&e.target.name===t.name&&(!(n.length>0)||n.includes(e.source.kind)))),i=e.map((t=>t.source.name));s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&i.includes(e.source.name))),s.push(...e)}const o=s?[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],a=this.targetTargetRelations(t.kind,n,o);if(null==e?void 0:e.includeAlternative){const t=[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))];i=this.originalData.relations.filter((i=>t.includes(`${i.target.kind}::${i.target.name}`)&&e.name===i.source.kind))}const r=this.originalData.relations.filter((e=>(!(n.length>0)||n.includes(e.target.kind))&&e.target.kind===t.kind&&e.target.name===t.name)),d=r?[...new Set(r.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],l=this.originalData.relations.filter((t=>(!(n.length>0)||n.includes(t.target.kind))&&d.includes(`${t.target.kind}::${t.target.name}`))),h=[...new Set([...s,...a,...l,...i,...r].map((t=>JSON.stringify(t))))].map((t=>JSON.parse(t)));return t.hasRelationsOfSameKinds=!!h.find((e=>e.source.kind===t.kind||e.target.kind===t.kind)),{relations:h,hasRelatedSourceOfOtherKinds:i.length>0}}targetTargetRelations(t,e,i){return this.options.showSameKindsOnNonSelected?this.originalData.relations.filter((t=>(!(e.length>0)||e.includes(t.target.kind))&&i.includes(t.source.kind+"::"+t.source.name))):this.originalData.relations.filter((n=>(n.target.kind!==n.source.kind||n.source.kind===t)&&(!(e.length>0)||e.includes(n.target.kind))&&i.includes(n.source.kind+"::"+n.source.name)))}filterNodes(t){const e=t.flatMap((t=>`${t.target.kind}::${t.target.name}`)),i=t.flatMap((t=>`${t.source.kind}::${t.source.name}`));this.selectedNode&&i.push(`${this.selectedNode.kind}::${this.selectedNode.name}`);const n=[...new Set(e.concat(i))];return this.originalData.nodes.filter((t=>n.includes(`${t.kind}::${t.name}`)))}mergeData(t,e){return e.nodes.forEach((e=>{const i=t.nodes.findIndex((t=>t.kind===e.kind&&t.name===e.name));if(-1!==i){const n=t.nodes[i];t.relations.filter((t=>n.kind===t.source.kind&&n.name===t.source.name||n.kind===t.target.kind&&n.name===t.target.name)).forEach((e=>{const i=t.relations.indexOf(e);-1!==i&&t.relations.splice(i,1)})),t.nodes[i]=e}else t.nodes.push(e)})),e.relations.forEach((e=>{-1===t.relations.findIndex((t=>t.source.kind===e.source.kind&&t.source.name===e.source.name&&t.target.kind===e.target.kind&&t.target.name===e.target.name))&&t.relations.push(e)})),t}}class s{constructor(){this.listeners=new Map}subscribe(t,e){var i;this.listeners.has(t)||this.listeners.set(t,[]),null===(i=this.listeners.get(t))||void 0===i||i.push(e)}unsubscribe(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t),n=i.indexOf(e);-1!==n&&i.splice(n,1)}}dispatchEvent(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t).slice();for(const t of i)t(e)}}}const o=class{constructor(t,e){this.SVG_NS="http://www.w3.org/2000/svg",this.options={nodeWidth:10,nodeLineHeight:18,marginX:15,marginY:5,leftX:15,topY:10,nodeMarginY:10,nodeColumnWith:300,defaultNodeColor:"gray",renderKindAsColums:!0,trafficLog10Factor:12,relationDefaultWidth:15,relation:{selectedOpacity:.2,analyticsOpacity:.2,opacity:.2,environment:{nonPROD:{dashArray:"10,1"}},sameKindIndentation:20},selectedNode:{dropShadow:!1,borderColor:"#ff1010",hoverOpacity:.2},truncateText:{defaultFontSizeAndFamily:"16px Arial",ellipseCharacter:"…"},rootCharacter:"⌂"},e&&this.setOptions(e),this.calculatedHeight=0,this.svgElement=t,this.nodePositions={},this.eventHandler=new s,this.contextMenuCallbackFunction=void 0,this.className={NODE_TYPE_TITLE:"node-kind-title",NODE_TITLE:"node-title",RELATION:"relation",CARDINALITY:"cardinality",SELECTED:"selected"},this.selectedNodePositionY=-1,this.truncateText=this.createTruncateText()}setOptions(t){this.options=this.deepMerge(this.options,t)}setData(t){this.chartData!==t&&(this.chartData=t,this.render(),this.eventHandler.dispatchEvent("selectionChanged",{node:this.chartData.getSelectedNode(),position:{y:0}}))}getData(){return this.chartData}addSelectionChangedListeners(t){var e;"function"==typeof t&&(this.eventHandler.subscribe("selectionChanged",t),t({node:null===(e=this.chartData)||void 0===e?void 0:e.getSelectedNode(),position:{y:0}}))}addContextMenuListeners(t){"function"==typeof t&&(this.contextMenuCallbackFunction=t)}addFetchDataListeners(t){"function"==typeof t&&this.eventHandler.subscribe("fetchData",t)}createTruncateText(){const t=document.createElement("canvas").getContext("2d"),e=new Map,i=this.options.truncateText.ellipseCharacter,n=this.options.truncateText.defaultFontSizeAndFamily;return function(s,o,a=n){const r=`${s}-${o}-${a}`;if(e.has(r))return e.get(r);if(!t)return s;if(t.font=a,t.measureText(s).width<=o)return e.set(r,s),s;let d=s;for(;t.measureText(d+i).width>o;)d=d.slice(0,-1);const l=d+i;return e.set(r,l),l}}resetSvg(){this.calculatedHeight=0,this.svgElement.innerHTML='\n      <defs>\n        <filter id="dropshadow">\n          <feGaussianBlur stdDeviation="0.4" />\n        </filter>\n      </defs>\n    '}updateHeight(){var t,e,i;const n=((null!==(t=this.options.nodeColumnWith)&&void 0!==t?t:0)+(null!==(e=this.options.nodeWidth)&&void 0!==e?e:0))*Math.max(1,(null===(i=this.chartData)||void 0===i?void 0:i.getKinds().length)||0)+2*this.options.marginX;this.svgElement.setAttribute("height",this.calculatedHeight.toString()),this.svgElement.setAttribute("width",n.toString())}renderElipsisMenu(t,e,i){const n=document.createElementNS(this.SVG_NS,"g");n.setAttribute("id","ellipsisMenu"),n.setAttribute("style","cursor: pointer;"),n.setAttribute("transform",`translate(${t+2.5}, ${e})`);const s=this.createRect(-2.5,0,this.options.nodeWidth,22,"black","0.2");s.setAttribute("rx","5"),s.setAttribute("ry","5"),n.appendChild(s);for(let t=5;t<=15;t+=5){const e=this.createCircle(2.5,t,2,"white");n.appendChild(e)}return n.addEventListener("click",(t=>{this.contextMenuCallbackFunction&&(this.contextMenuCallbackFunction(t,i),t.stopPropagation())})),n}deepMerge(t,e){if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return e;for(const i of Object.keys(e))Array.isArray(e[i])?t[i]=e[i].slice():"object"==typeof e[i]&&null!==e[i]?(t[i]||(t[i]={}),this.deepMerge(t[i],e[i])):t[i]=e[i];return t}renderNodes(t,e,i,n){var s,o,a,r;const d=document.createElementNS(this.SVG_NS,"g");let l=this.options.topY;if(this.options.renderKindAsColums){const t=(null==n?void 0:n.title)||(null===(o=null===(s=this.chartData)||void 0===s?void 0:s.getTitle())||void 0===o?void 0:o.name),i=(null==n?void 0:n.color)||(null===(r=null===(a=this.chartData)||void 0===a?void 0:a.getTitle())||void 0===r?void 0:r.color)||this.options.defaultNodeColor,h=e+this.options.nodeWidth/2,c=this.options.topY+this.options.marginY+this.options.nodeWidth/2;let u=e+this.options.nodeWidth+this.options.nodeMarginY/2;const g=this.options.topY+this.options.marginY+this.options.nodeWidth;let p="";if(null==n?void 0:n.color){const t=this.createCircle(h,c,5,i);d.appendChild(t)}else p="| ",u-=13;const m=this.createSvgText(p+t,[this.className.NODE_TYPE_TITLE]);m.setAttribute("x",u.toString()),m.setAttribute("y",g.toString()),d.appendChild(m),l+=25}return t.forEach(((t,n)=>{var s;const o=t.sourceRelations||{height:0,count:0},a=t.targetRelations||{height:0,count:0},r=(1+(t.subtitle?1:0)+((null===(s=t.tags)||void 0===s?void 0:s.length)?1:0)+(this.options.renderKindAsColums?0:1))*this.options.nodeLineHeight+this.options.marginY;t.textLinesHeight=r;const h=!(!i||i.name!==t.name||i.kind!==t.kind),c=2*this.options.marginY+Math.max(r,r+(o.height>0?o.height+12:0),a.height>0?a.height+12:0),u=this.options.marginY+l,g=t.color||this.options.defaultNodeColor;let p=e,m=this.options.nodeColumnWith;h&&(this.selectedNodePositionY=u),t.hasRelatedSourceOfSameKind&&(p+=this.options.relation.sameKindIndentation,m-=this.options.relation.sameKindIndentation);const v=document.createElementNS(this.SVG_NS,"g"),f=this.createRect(p,u,m,c,g,"0"),S=this.createRect(p,u,this.options.nodeWidth,c,g);if(h){const t=this.createRect(p-2,u-2,this.options.nodeWidth+4,c+4,"none");t.setAttribute("rx","6"),t.setAttribute("ry","6"),this.options.selectedNode.dropShadow?(t.setAttribute("fill","black"),t.setAttribute("filter","url(#dropshadow)"),t.setAttribute("opacity","0.2")):this.options.selectedNode.borderColor&&(t.setAttribute("stroke-width","2"),t.setAttribute("stroke",this.options.selectedNode.borderColor),t.setAttribute("fill","none"),t.setAttribute("opacity","1")),v.appendChild(t)}v.appendChild(S),f.style.cursor="pointer",v.appendChild(f),t.cardinality&&this.appendCardinalityText(v,t.cardinality,p,u,c,g,h);const k=this.createSvgText("",[this.className.NODE_TITLE,h?this.className.SELECTED:""]);k.setAttribute("x",String(p+this.options.marginX)),k.setAttribute("y",u.toString());this.createTextLines(t,this.options.nodeColumnWith-this.options.nodeWidth).forEach(((t,e)=>{const i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("x",String(p+this.options.marginX)),i.setAttribute("dy","1.2em"),i.textContent=t.text,i.classList.add(t.class),k.appendChild(i)})),v.appendChild(k),(null==t?void 0:t.placeHolder)||this.addHoverAndClickEvents(v,f,t),d.appendChild(v),h&&!(null==t?void 0:t.placeHolder)&&this.contextMenuCallbackFunction&&d.appendChild(this.renderElipsisMenu(p,u,t)),this.nodePositions[t.kind+"::"+t.name]={node:t,x:p,y:u,index:n,sourceY:u+this.options.marginY,targetY:u,height:c,textLinesHeight:t.textLinesHeight,sourceIndex:0,targetIndex:0,accumulatedSourceY:0,accumulatedTargetY:0},l+=c+this.options.nodeMarginY})),this.calculatedHeight=Math.max(this.calculatedHeight,l+2*this.options.nodeMarginY),d}createCircle(t,e,i,n){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("cx",t.toString()),s.setAttribute("cy",e.toString()),s.setAttribute("r",i.toString()),s.setAttribute("fill",n),s}createRect(t,e,i,n,s,o="1"){const a=document.createElementNS(this.SVG_NS,"rect");return a.setAttribute("x",t.toString()),a.setAttribute("y",e.toString()),a.setAttribute("width",i.toString()),a.setAttribute("height",n.toString()),a.setAttribute("rx","5"),a.setAttribute("ry","5"),a.setAttribute("fill",s),a.setAttribute("opacity",o),a}appendCardinalityText(t,e,i,n,s,o,a){var r,d;if(null!==(r=e.sourceCount)&&void 0!==r&&r){const r=this.createSvgText("- "+e.sourceCount+(e.refs>0?"+"+e.refs:""),[this.className.CARDINALITY,a?this.className.SELECTED:""]);r.setAttribute("x",String(i+this.options.marginX-6)),r.setAttribute("y",String(n+s-2)),r.setAttribute("fill",o),t.appendChild(r)}if(null!==(d=e.targetCount)&&void 0!==d&&d){const r=this.createSvgText(e.targetCount+" -",[this.className.CARDINALITY,a?this.className.SELECTED:""]);r.setAttribute("x",String(i+this.options.marginX-14)),r.setAttribute("y",String(n+s-2)),r.setAttribute("fill",o),r.setAttribute("text-anchor","end"),t.appendChild(r)}}createTextLines(t,e){const i=[{text:this.truncateText?this.truncateText(t.title?t.title:t.name,e):t.title?t.title:t.name,class:"headline"}];if(t.subtitle){const n=this.truncateText?this.truncateText(t.subtitle,e):t.subtitle;i.splice(1,0,{text:n,class:"subtitle"})}if(t.tags){const n=this.truncateText?this.truncateText(t.tags.join(", "),e):t.tags.join(", ");i.push({text:n,class:"description"})}return this.options.renderKindAsColums||i.push({text:t.kind.charAt(0).toUpperCase()+t.kind.slice(1),class:"description"}),i}addHoverAndClickEvents(t,e,i){t.addEventListener("click",(t=>{var e,n;null===(e=this.chartData)||void 0===e||e.selectNode(i),this.render(),(null===(n=null==i?void 0:i.cardinality)||void 0===n?void 0:n.fetchMore)&&this.eventHandler.dispatchEvent("fetchData",{node:i}),this.eventHandler.dispatchEvent("selectionChanged",{node:i,position:{y:this.selectedNodePositionY}})})),t.addEventListener("mouseenter",(t=>{e.setAttribute("opacity",this.options.selectedNode.hoverOpacity.toString())})),t.addEventListener("mouseleave",(t=>{e.setAttribute("opacity","0")}))}createSvgText(t,e){const i=document.createElementNS(this.SVG_NS,"text");return i.classList.add(...e.filter((t=>t))),i.textContent=t,i}renderRelations(t,e){const{name:i,kind:n,color:s}=e||{},o=s||this.options.defaultNodeColor,a=JSON.parse(JSON.stringify(this.nodePositions)),r=document.createElementNS(this.SVG_NS,"g"),d=document.createElementNS(this.SVG_NS,"g");null==t||t.forEach((t=>{var s,l,h,c,u,g;document.createElementNS(this.SVG_NS,"g");const p=a[t.source.kind+"::"+t.source.name],m=a[t.target.kind+"::"+t.target.name];if(!m||!p)return;const v=p.node.color||o,f=t.source.kind===t.target.kind,S=f?0:this.calculateGap(p.sourceIndex++),k=null!==(s=p.textLinesHeight)&&void 0!==s?s:0;k>0&&(p.textLinesHeight=0),p.accumulatedSourceY=k+p.accumulatedSourceY+S;const y=f?0:this.calculateGap(m.targetIndex++);m.accumulatedTargetY=(null!==(l=m.accumulatedTargetY)&&void 0!==l?l:0)+y;const{source:N,target:b,height:C}=t,x=p.x+this.options.nodeWidth,A=p.sourceY+(C||0)/2+p.accumulatedSourceY,E=this.options.marginY+m.targetY+(C||0)/2+m.accumulatedTargetY,w=(p.x+this.options.nodeWidth+m.x)/2;let T,$=this.options.relation.opacity,D=C;if((t.source.kind===n&&t.source.name===i||t.target.kind===n&&t.target.name===i)&&($+=this.options.relation.selectedOpacity),N.kind===b.kind){if(p.index<m.index){const t=p.x+this.options.nodeWidth/2,e=p.y+p.height,i=m.x+this.options.nodeWidth/2,n=m.y+m.height/2;T=`M${t},${e} C${t},${n} ${t},${n} ${i},${n}`}else{const t=p.x+this.options.nodeWidth/2,e=p.y+p.height/2,i=m.x+this.options.nodeWidth/2;T=`M${i},${m.y+m.height} C${i},${e} ${i},${e} ${t},${e}`}$=.8,D=2}else T=`M${x},${A} C${w},${A} ${w},${E} ${m.x},${E}`;const M=document.createElementNS("http://www.w3.org/2000/svg","path");let O;if(M.setAttribute("d",T),M.setAttribute("fill","none"),M.setAttribute("stroke-width",String(D||0)),M.setAttribute("stroke",v),d.appendChild(M),O);else{O=t.analytics;t.target.kind===(null==e?void 0:e.kind)||(t.source.kind,null==e||e.kind)}if(null!==(h=null==O?void 0:O.traffic)&&void 0!==h&&h){const t=this.createSvgText("",[this.className.RELATION]);t.setAttribute("x",String(m.x-this.options.marginY)),t.setAttribute("y",String(m.targetY+(C||0)+y)),t.setAttribute("text-anchor","end");const e=document.createElementNS(this.SVG_NS,"tspan");if(e.textContent=(null==O?void 0:O.environment)||"",t.appendChild(e),(null==O?void 0:O.environment)&&this.options.relation.environment[null==O?void 0:O.environment]&&M.setAttribute("stroke-dasharray",this.options.relation.environment[O.environment].dashArray),null!==(c=null==O?void 0:O.errors)&&void 0!==c&&c){const e=100/(null!==(u=null==O?void 0:O.traffic)&&void 0!==u?u:0)*(null!==(g=null==O?void 0:O.errors)&&void 0!==g?g:0),i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("fill","red"),i.textContent=" "+(0==e?"(<0.01%)":"("+e.toFixed(2).toLocaleString()+"%)"),t.appendChild(i)}const i=document.createElementNS(this.SVG_NS,"tspan");i.textContent=" "+(null==O?void 0:O.traffic.toLocaleString()),t.appendChild(i),r.appendChild(t),$+=this.options.relation.analyticsOpacity}else N.kind,b.kind;p.sourceY+=null!=C?C:0,m.targetY+=null!=C?C:0,M.setAttribute("opacity",String($))})),this.svgElement.appendChild(d),this.svgElement.appendChild(r)}render(){var t,e,i,n,s,o,a,r,d;const l=null===(t=this.chartData)||void 0===t?void 0:t.getSelectedNode();this.resetSvg(),this.updateRelationWeights(null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getNodes())&&void 0!==i?i:[],null!==(s=null===(n=this.chartData)||void 0===n?void 0:n.getRelations())&&void 0!==s?s:[],l);let h=0;const c=this.options.nodeColumnWith+this.options.nodeWidth,u=null===(o=this.chartData)||void 0===o?void 0:o.getKinds();this.selectedNodePositionY=-1;const g=document.createElementNS(this.SVG_NS,"g");u&&u.length>0?u.forEach((t=>{var e,i;g.appendChild(this.renderNodes(null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getNodesByKind(t.name))&&void 0!==i?i:[],this.options.leftX+c*h++,l,t))})):g.appendChild(this.renderNodes(null!==(r=null===(a=this.chartData)||void 0===a?void 0:a.getNodes())&&void 0!==r?r:[],this.options.leftX+0)),this.renderRelations(null===(d=this.chartData)||void 0===d?void 0:d.getRelations(),l),this.svgElement.appendChild(g),this.updateHeight()}updateRelationWeights(t,e,i){if(!e)return;const n=e.reduce(((t,e)=>{var i,n;const{source:s,target:o,analytics:a}=e;if(s.kind===o.kind)return e.height=0,t;const r=`s${s.kind}:${s.name}`,d=`t${o.kind}:${o.name}`,l=(null==a?void 0:a.traffic)&&a.traffic>0?Math.round(Math.log10(Math.max(a.traffic,2))*(null!==(i=this.options.trafficLog10Factor)&&void 0!==i?i:12)):null!==(n=this.options.relationDefaultWidth)&&void 0!==n?n:10;return e.height=l,t[r]||(t[r]={height:0,count:0}),t[d]||(t[d]={height:0,count:0}),t[r].height+=l+this.calculateGap(t[r].count),t[r].count+=1,t[d].height+=l+this.calculateGap(t[d].count),t[d].count+=1,t}),{});t.forEach((t=>{t.sourceRelations=n[`s${t.kind}:${t.name}`],t.targetRelations=n[`t${t.kind}:${t.name}`]}))}calculateGap(t){return Math.min(80,3*t)}};class a{constructor(t,e,i,n,s){this.maxPreviewWidth=100,this.largeSVG=t,this.overlay=e,this.previewSVG=i,this.previewPane=n,this.mainViewport=s,this.initialize(),this.setupScrollSync()}initialize(){const t=this.largeSVG.width.baseVal.value,e=this.largeSVG.height.baseVal.value,i=this.mainViewport.offsetWidth,n=this.mainViewport.offsetHeight;if(t<=i&&e<=n)this.previewPane.style.display="none";else{this.previewPane.style.display="unset";const s=i/t,o=n/e,a=Math.min(this.maxPreviewWidth/t,s,o),r=t*a,d=e*a;this.previewPane.style.width=`${r}px`,this.previewPane.style.height=`${d}px`,this.previewSVG.setAttribute("width",r.toString()),this.previewSVG.setAttribute("height",d.toString());this.previewSVG.querySelector("use").setAttribute("transform",`scale(${a})`);const l=2;this.overlay.setAttribute("width",(i*a-l).toString()),this.overlay.setAttribute("height",(n*a-l).toString()),this.enableOverlayDrag(a,l)}}enableOverlayDrag(t,e){let i=!1,n=0,s=0;this.overlay.addEventListener("mousedown",(t=>{i=!0;const e=this.overlay.getBoundingClientRect();n=t.clientX-e.left,s=t.clientY-e.top,this.overlay.style.cursor="grabbing"})),document.addEventListener("mousemove",(o=>{if(!i)return;const a=this.previewSVG.getBoundingClientRect(),r=e+o.clientX-a.left-n,d=o.clientY-a.top-s,l=this.previewSVG.width.baseVal.value-this.overlay.width.baseVal.value,h=this.previewSVG.height.baseVal.value-this.overlay.height.baseVal.value,c=Math.max(0,Math.min(r,l)),u=Math.max(0,Math.min(d,h));this.overlay.setAttribute("x",c.toString()),this.overlay.setAttribute("y",u.toString()),this.largeSVG.style.transform=`translate(${-c/t}px, ${-u/t}px)`})),document.addEventListener("mouseup",(()=>{i&&(i=!1,this.overlay.style.cursor="grab")})),this.overlay.style.cursor="grab"}setupScrollSync(){const t=this.largeSVG.width.baseVal.value,e=this.largeSVG.height.baseVal.value,i=parseFloat(this.previewSVG.getAttribute("width"))/t;this.mainViewport.addEventListener("scroll",(()=>{const t=this.mainViewport.scrollLeft,e=this.mainViewport.scrollTop,n=t*i,s=e*i;this.overlay.setAttribute("x",n.toString()),this.overlay.setAttribute("y",s.toString())})),this.overlay.addEventListener("mousedown",(n=>{let s=!0,o=0,a=0;const r=this.overlay.getBoundingClientRect();o=n.clientX-r.left,a=n.clientY-r.top;const d=n=>{if(!s)return;const r=this.previewSVG.getBoundingClientRect(),d=n.clientX-r.left-o,l=n.clientY-r.top-a,h=Math.max(0,Math.min(d,t*i-this.overlay.width.baseVal.value)),c=Math.max(0,Math.min(l,e*i-this.overlay.height.baseVal.value));this.overlay.setAttribute("x",h.toString()),this.overlay.setAttribute("y",c.toString()),this.mainViewport.scrollLeft=h/i,this.mainViewport.scrollTop=c/i},l=()=>{s=!1,document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",l)}))}}return window.SankeyChart=o,window.SankeyChartData=n,window.EventHandler=s,window.Preview=a,i})()));