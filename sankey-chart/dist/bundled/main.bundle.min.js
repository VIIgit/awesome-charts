!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SankeyChartLibrary=e():t.SankeyChartLibrary=e()}(this,(()=>(()=>{"use strict";var t,e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},i={};e.r(i),e.d(i,{EventHandler:()=>s,IncludeKind:()=>t,Minimap:()=>a,SankeyChart:()=>o,SankeyChartData:()=>n}),function(t){t.WITH_SAME_TARGET="WITH_SAME_TARGET"}(t||(t={}));class n{constructor(t,e,i=!1){this.getNodeTagColor=t=>{const e=t.tags?t.tags.map((t=>{var e;return null===(e=this.options.tagColorMap)||void 0===e?void 0:e[t]})).find((t=>void 0!==t)):this.options.defaultColor;return t.color||e},this.selectedNode=void 0,this.nodes=[],this.dependencies={relations:[],hasRelatedSourceOfOtherKinds:!1},this.originalData={name:t.name,color:t.color,nodes:(t.nodes||[]).map((t=>Object.assign({},t))),relations:t.relations||[]},this.allNodesLoaded=!i,this.nodesByKinds={},this.title=void 0,this.options={noTag:"Others",noTagSuffixCharacter:"…",relationDefaultWidth:15,defaultColor:"orange",tagColorMap:{},kinds:[],showRelatedKinds:!1,selectAndFilter:!0},this.setOptions(e)}initialize(){this.initializeSortRelations(),this.initializeRelationsInfo()}resetColors(){if(this.options.tagColorMap){const t=Object.keys(this.options.tagColorMap);this.nodes.forEach((e=>{(t.some((t=>{var i;return null===(i=e.tags)||void 0===i?void 0:i.includes(t)}))||e.color===this.options.defaultColor)&&delete e.color}))}else this.nodes.forEach((t=>delete t.color))}setOptions(t){this.resetColors(),this.options=Object.assign(Object.assign({},this.options),t);const e=this.selectedNode;this.initialize(),this.selectedNode=void 0,this.selectNode(e)}appendData(t,e){this.selectedNode=void 0,this.mergeData(this.originalData,t),this.initialize(),this.selectNode(e)}getNodes(){return this.nodes||[]}getNodesByKind(t){var e;return null!==(e=this.nodesByKinds[t])&&void 0!==e?e:[]}getRelations(){return this.dependencies.relations||[]}getKinds(){var t,e;const i=Object.keys(this.nodesByKinds);return(null===(e=null===(t=this.options)||void 0===t?void 0:t.kinds)||void 0===e?void 0:e.length)>0?this.options.kinds.filter((t=>i.includes(t.name))):i.map((t=>({name:t})))}getTitle(){return this.title}setTitle(t){this.title=t?{title:t.title,name:t.name,color:t.color}:void 0}getSelectedNode(){return this.selectedNode}selectNode(t){const e=t=>{const e={};return t.forEach((t=>{e[t.kind]||(e[t.kind]=[]),e[t.kind].push(t)})),e};if(t){if(!t.kind||!t.name)throw new Error("Node must have kind and name");if(this.selectedNode&&t.name===this.selectedNode.name&&t.kind===this.selectedNode.kind)return this.selectedNode;if(this.selectedNode=this.originalData.nodes.find((e=>e.name===t.name&&e.kind===t.kind)),this.selectedNode){const t=this.options.kinds.find((t=>{var e;return t.name===(null===(e=this.selectedNode)||void 0===e?void 0:e.kind)}));(null==t?void 0:t.includeAlternative)?this.selectedNode.hasRelatedSourceOfOtherKinds=!0:delete this.selectedNode.hasRelatedSourceOfOtherKinds,this.selectedNode.hasRelatedSourceOfOtherKinds=!!(null==t?void 0:t.includeAlternative),this.options.selectAndFilter&&(this.options.showRelatedKinds?this.dependencies=this.filterDependencies(this.selectedNode,t):this.dependencies=this.filterDependencies(this.selectedNode),this.nodes=this.filterNodes(this.dependencies.relations),this.nodes.forEach((t=>{t.hasRelatedSourceOfSameKind=!!this.dependencies.relations.find((e=>e.target.kind===t.kind&&e.target.name===t.name&&e.source.kind===t.kind))})))}else this.nodes=[];this.nodesByKinds=e(this.nodes)}else this.nodes=this.originalData.nodes,this.dependencies.relations=this.originalData.relations||[],this.nodesByKinds=e(this.nodes),this.selectedNode=void 0;return this.sortNodes(),this.selectedNode}sortNodesAlpabetically(t){const e=(this.options.noTag||"")+this.options.noTagSuffixCharacter;t.sort(((t,i)=>t.name===e&&i.name!==e?1:t.name!==e&&i.name===e?-1:0))}sortNodes(){const t=this.getSelectedNode();if(!t)return void this.sortNodesAlpabetically(this.getNodes());let e=[];const i=this.options.kinds.findIndex((e=>e.name===(null==t?void 0:t.kind)));for(let n=i;n<this.options.kinds.length;n++){const i=this.options.kinds[n],s=this.nodesByKinds[i.name];s&&(this.sortNodesOfKind(i,s,e,t),e=s)}const n=this.options.kinds[i];e=this.nodesByKinds[n.name];for(let n=i-1;n>=0;n--){const i=this.options.kinds[n],s=this.nodesByKinds[i.name];s&&(this.sortNodesOfKind(i,s,e,t),e=s)}this.sortRelations()}sortNodesOfKind(t,e,i,n){if(t.name===(null==n?void 0:n.kind)){const i=this.getRelations(),s=i.filter((e=>e.source.name===n.name&&e.source.kind===t.name&&e.target.kind===t.name)).map((t=>t.target.name)),o=i.filter((e=>e.target.name===n.name&&e.target.kind===t.name&&e.source.kind===t.name)).map((t=>t.source.name));e.sort(((t,e)=>{const i=t=>{if(o.length>0){if(o.includes(t.name))return 1;if(t.name===n.name)return 2}else{if(t.name===n.name)return 1;if(s.includes(t.name))return 2}return 3},a=i(t),r=i(e);return a!==r?a-r:t.name.localeCompare(e.name)}))}else{const t=this.getRelations();e.sort(((e,n)=>{const s=t.filter((t=>t.target.name===e.name&&t.target.kind===e.kind)),o=t.filter((t=>t.target.name===n.name&&t.target.kind===n.kind)),a=i.findIndex((t=>s.some((e=>e.source.name===t.name)))),r=i.findIndex((t=>o.some((e=>e.source.name===t.name))));return-1!==a||-1!==r?a===r?e.name.localeCompare(n.name):r>a?-1:1:e.name.localeCompare(n.name)}))}}sortRelations(){const t={},e=1e5;Object.keys(this.nodesByKinds).forEach((i=>{let n=e;this.nodesByKinds[i].forEach((e=>{t[i+"::"+e.name]=n++}))}));const i=this.getRelations();null==i||i.sort(((i,n)=>{var s,o,a,r;const d=`${i.source.kind}::${i.source.name}`,l=`${n.source.kind}::${n.source.name}`,h=`${i.target.kind}::${i.target.name}`,c=`${n.target.kind}::${n.target.name}`,u=null!==(s=t[d])&&void 0!==s?s:Number.MAX_SAFE_INTEGER,m=null!==(o=t[l])&&void 0!==o?o:Number.MAX_SAFE_INTEGER,g=null!==(a=t[h])&&void 0!==a?a:Number.MAX_SAFE_INTEGER,p=null!==(r=t[c])&&void 0!==r?r:Number.MAX_SAFE_INTEGER;return u*e+g-(m*e+p)}))}initializeSortRelations(){var t;null===(t=this.originalData.relations)||void 0===t||t.sort(((t,e)=>t.source.kind!==e.source.kind?t.source.kind.localeCompare(e.source.kind):t.source.name.localeCompare(e.source.name))).sort(((t,e)=>t.source.kind===e.source.kind&&t.source.name===e.source.name?t.target.kind!==e.target.kind?t.target.kind.localeCompare(e.target.kind):t.target.name.localeCompare(e.target.name):0))}initializeRelationsInfo(){var t;const e={};null===(t=this.originalData.relations)||void 0===t||t.forEach((t=>{const i=t.source.kind+"::"+t.source.name;e[i]||(e[i]={sourceCount:0,targetCount:0,sameKindCount:0}),t.source.kind===t.target.kind?e[i].sameKindCount++:e[i].sourceCount++;const n=t.target.kind+"::"+t.target.name;e[n]||(e[n]={sourceCount:0,targetCount:0,sameKindCount:0}),e[n].targetCount++})),this.originalData.nodes.forEach((t=>{var i;const n=e[t.kind+"::"+t.name];t.color=this.getNodeTagColor(t),t.cardinality=n,t.targetCount&&(t.cardinality={targetCount:t.targetCount,sameKindCount:0}),t.sourceCount&&(t.cardinality=Object.assign(null!==(i=t.cardinality)&&void 0!==i?i:{},{sourceCount:t.sourceCount,sameKindCount:0}))}))}searchByName(t){if(!t.kind||!t.name)throw new Error("Filter criteria is empty");return this.originalData.nodes.filter((e=>e.kind===t.kind&&e.name.includes(t.name)))}filterDependencies(t,e){let i=[];const n=this.options.kinds.map((t=>t.name));let s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&e.source.name===t.name&&(!(n.length>0)||n.includes(e.target.kind))));if(0==s.length){const e=this.originalData.relations.filter((e=>e.target.kind===t.kind&&e.target.name===t.name&&(!(n.length>0)||n.includes(e.source.kind)))),i=e.map((t=>t.source.name));s=this.originalData.relations.filter((e=>e.source.kind===t.kind&&i.includes(e.source.name))),s.push(...e)}const o=s?[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],a=this.targetTargetRelations(t.kind,n,o);if(null==e?void 0:e.includeAlternative){const t=[...new Set(s.flatMap((t=>`${t.target.kind}::${t.target.name}`)))];i=this.originalData.relations.filter((i=>t.includes(`${i.target.kind}::${i.target.name}`)&&e.name===i.source.kind))}const r=this.originalData.relations.filter((e=>(!(n.length>0)||n.includes(e.target.kind))&&e.target.kind===t.kind&&e.target.name===t.name)),d=r?[...new Set(r.flatMap((t=>`${t.target.kind}::${t.target.name}`)))]:[],l=this.originalData.relations.filter((t=>(!(n.length>0)||n.includes(t.target.kind))&&d.includes(`${t.target.kind}::${t.target.name}`))),h=[...new Set([...s,...a,...l,...i,...r].map((t=>JSON.stringify(t))))].map((t=>JSON.parse(t)));return t.hasRelationsOfSameKinds=!!h.find((e=>e.source.kind===t.kind||e.target.kind===t.kind)),{relations:h,hasRelatedSourceOfOtherKinds:i.length>0}}targetTargetRelations(t,e,i){return this.options.showSameKindsOnNonSelected?this.originalData.relations.filter((t=>(!(e.length>0)||e.includes(t.target.kind))&&i.includes(t.source.kind+"::"+t.source.name))):this.originalData.relations.filter((n=>(n.target.kind!==n.source.kind||n.source.kind===t)&&(!(e.length>0)||e.includes(n.target.kind))&&i.includes(n.source.kind+"::"+n.source.name)))}filterNodes(t){const e=t.flatMap((t=>`${t.target.kind}::${t.target.name}`)),i=t.flatMap((t=>`${t.source.kind}::${t.source.name}`));this.selectedNode&&i.push(`${this.selectedNode.kind}::${this.selectedNode.name}`);const n=[...new Set(e.concat(i))];return this.originalData.nodes.filter((t=>n.includes(`${t.kind}::${t.name}`)))}mergeData(t,e){return e.nodes.forEach((e=>{const i=t.nodes.findIndex((t=>t.kind===e.kind&&t.name===e.name));if(-1!==i){const n=t.nodes[i];t.relations.filter((t=>n.kind===t.source.kind&&n.name===t.source.name||n.kind===t.target.kind&&n.name===t.target.name)).forEach((e=>{const i=t.relations.indexOf(e);-1!==i&&t.relations.splice(i,1)})),t.nodes[i]=e}else t.nodes.push(e)})),e.relations.forEach((e=>{-1===t.relations.findIndex((t=>t.source.kind===e.source.kind&&t.source.name===e.source.name&&t.target.kind===e.target.kind&&t.target.name===e.target.name))&&t.relations.push(e)})),t}}class s{constructor(){this.listeners=new Map}subscribe(t,e){var i;this.listeners.has(t)||this.listeners.set(t,[]),null===(i=this.listeners.get(t))||void 0===i||i.push(e)}unsubscribe(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t),n=i.indexOf(e);-1!==n&&i.splice(n,1)}}dispatchEvent(t,e){if(this.listeners.has(t)){const i=this.listeners.get(t).slice();for(const t of i)t(e)}}}const o=class{constructor(t,e){this.SVG_NS="http://www.w3.org/2000/svg",this.svgElement=t,this.className={NODE_TYPE_TITLE:"node-kind-title",NODE_TITLE:"node-title",RELATION:"relation",CARDINALITY:"cardinality",SELECTED:"selected"},this.options={nodeWidth:10,nodeLineHeight:18,marginX:15,marginY:5,leftX:15,topY:10,nodeMarginY:10,nodeColumnWidth:300,defaultNodeColor:"gray",renderKindAsColums:!0,trafficLog10Factor:12,relationDefaultWidth:15,relation:{selectedOpacity:.2,analyticsOpacity:.2,opacity:.2,environment:{nonPROD:{dashArray:"10,1"}},sameKindIndentation:20},selectedNode:{dropShadow:!1,borderColor:"#ff1010",hoverOpacity:.2},truncateText:{defaultFontSizeAndFamily:"16px Arial",ellipseCharacter:"…"},rootCharacter:"⌂"},e&&this.setOptions(e),this.calculatedHeight=0,this.nodePositions={},this.eventHandler=new s,this.contextMenuCallbackFunction=void 0,this.selectedNodePositionY=-1,this.truncateText=this.createTruncateText(),this.initCss()}setOptions(t){t.nodeColumnWidth=Number(t.nodeColumnWidth||this.options.nodeColumnWidth),this.options=this.deepMerge(this.options,t),this.render()}setData(t){this.chartData!==t&&(this.chartData=t,this.render(),this.eventHandler.dispatchEvent("selectionChanged",{node:this.chartData.getSelectedNode(),position:{y:0}}))}addSelectionChangedListeners(t){var e;"function"==typeof t&&(this.eventHandler.subscribe("selectionChanged",t),t({node:null===(e=this.chartData)||void 0===e?void 0:e.getSelectedNode(),position:{y:0}}))}addContextMenuListeners(t){"function"==typeof t&&(this.contextMenuCallbackFunction=t)}getDirectTargetNodesOf(t){var e,i;return null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getRelations().filter((e=>e.source.kind===t.kind&&e.source.name===t.name)).map((t=>t.target)))&&void 0!==i?i:[]}initCss(){const t="svg-style";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent=" .svg-copy-icon { opacity: 0; transition: opacity 0.5s; }\n        g:hover > .svg-copy-icon { opacity: 1; }\n        .unselectable {user-select: none; -webkit-user-select: none;}",document.head.insertBefore(e,document.head.firstChild)}}getDirectSourceNodesOf(t){var e,i;return null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getRelations().filter((e=>e.target.kind===t.kind&&e.target.name===t.name)).map((t=>t.source)))&&void 0!==i?i:[]}createTruncateText(){const t=document.createElement("canvas").getContext("2d"),e=new Map,i=this.options.truncateText.ellipseCharacter,n=this.options.truncateText.defaultFontSizeAndFamily;return function(s,o,a=n){const r=`${s}-${o}-${a}`;if(e.has(r))return e.get(r);if(!t)return s;if(t.font=a,t.measureText(s).width<=o)return e.set(r,s),s;let d=s;for(;t.measureText(d+i).width>o;)d=d.slice(0,-1);const l=d+i;return e.set(r,l),l}}resetSvg(){this.calculatedHeight=0,this.svgElement.innerHTML='\n      <defs>\n        <filter id="dropshadow">\n          <feGaussianBlur stdDeviation="0.4" />\n        </filter>\n      </defs>\n    '}updateHeight(){var t,e,i;const n=((null!==(t=this.options.nodeColumnWidth)&&void 0!==t?t:0)+(null!==(e=this.options.nodeWidth)&&void 0!==e?e:0))*Math.max(1,(null===(i=this.chartData)||void 0===i?void 0:i.getKinds().length)||0)+2*this.options.marginX;this.svgElement.setAttribute("height",this.calculatedHeight.toString()),this.svgElement.setAttribute("width",n.toString())}renderElipsisMenu(t,e,i){const n=document.createElementNS(this.SVG_NS,"g");n.setAttribute("id","ellipsisMenu"),n.setAttribute("style","cursor: pointer;"),n.setAttribute("transform",`translate(${t+2.5}, ${e})`);const s=this.createRect(-2.5,0,this.options.nodeWidth,22,"black","0.2");s.setAttribute("rx","5"),s.setAttribute("ry","5"),n.appendChild(s);for(let t=5;t<=15;t+=5){const e=this.createCircle(2.5,t,2,"white");n.appendChild(e)}return n.addEventListener("click",(t=>{this.contextMenuCallbackFunction&&(this.contextMenuCallbackFunction(t,i),t.stopPropagation())})),n}deepMerge(t,e){if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return e;for(const i of Object.keys(e))Array.isArray(e[i])?t[i]=e[i].slice():"object"==typeof e[i]&&null!==e[i]?(t[i]||(t[i]={}),this.deepMerge(t[i],e[i])):t[i]=e[i];return t}renderNodes(t,e,i,n,s,o){var a,r,d,l;const h=document.createElementNS(this.SVG_NS,"g");let c=this.options.topY;if(this.options.renderKindAsColums){const t=(null==n?void 0:n.title)||(null===(r=null===(a=this.chartData)||void 0===a?void 0:a.getTitle())||void 0===r?void 0:r.name),i=(null==n?void 0:n.color)||(null===(l=null===(d=this.chartData)||void 0===d?void 0:d.getTitle())||void 0===l?void 0:l.color)||this.options.defaultNodeColor,s=e+this.options.nodeWidth/2,o=this.options.topY+this.options.marginY+this.options.nodeWidth/2;let u=e+this.options.nodeWidth+this.options.nodeMarginY/2;const m=this.options.topY+this.options.marginY+this.options.nodeWidth;let g="";if(null==n?void 0:n.color){const t=this.createCircle(s,o,5,i);h.appendChild(t)}else g="| ",u-=13;const p=this.createSvgText(g+t,[this.className.NODE_TYPE_TITLE]);p.setAttribute("x",u.toString()),p.setAttribute("y",m.toString()),h.appendChild(p),c+=25}return t.forEach(((t,i)=>{var n;const s=t.kind+"::"+t.name,o=this.nodePositions[s],a=o.sourceRelations,r=o.targetRelations,d=(1+(t.subtitle?1:0)+((null===(n=t.tags)||void 0===n?void 0:n.length)?1:0)+(this.options.renderKindAsColums?0:1))*this.options.nodeLineHeight+this.options.marginY,l=2*this.options.marginY+Math.max(d,d+(a.height>0?a.height+12:0),r.height>0?r.height+12:0),h=this.options.marginY+c;let u=e,m=this.options.nodeColumnWidth;t.hasRelatedSourceOfSameKind&&(u+=this.options.relation.sameKindIndentation,m-=this.options.relation.sameKindIndentation),Object.assign(o,{x:u,y:h,height:l,textLinesHeight:d,sourceY:h+this.options.marginY,targetY:h}),c+=l+this.options.nodeMarginY})),this.calculatedHeight=Math.max(this.calculatedHeight,c+2*this.options.nodeMarginY),t.forEach((t=>{const e=this.nodePositions[t.kind+"::"+t.name],n=!(!i||i.name!==t.name||i.kind!==t.kind),a=e.x,r=e.y,d=e.height,l=this.options.nodeColumnWidth-(t.hasRelatedSourceOfSameKind?this.options.relation.sameKindIndentation:0),c=t.color||this.options.defaultNodeColor,u=document.createElementNS(this.SVG_NS,"g"),m=this.createRect(a,r,l,d,c,"0"),g=this.createRect(a,r,this.options.nodeWidth,d,c);if(n){this.selectedNodePositionY=r;const t=this.createRect(a-2,r-2,this.options.nodeWidth+4,d+4,"none");t.setAttribute("rx","6"),t.setAttribute("ry","6"),this.options.selectedNode.dropShadow?(t.setAttribute("fill","black"),t.setAttribute("filter","url(#dropshadow)"),t.setAttribute("opacity","0.2")):this.options.selectedNode.borderColor&&(t.setAttribute("stroke-width","2"),t.setAttribute("stroke",this.options.selectedNode.borderColor),t.setAttribute("fill","none"),t.setAttribute("opacity","1")),u.appendChild(t)}if(u.appendChild(g),m.style.cursor="pointer",u.appendChild(m),t.cardinality||t.targetCount||t.sourceCount){const e=!!(null==s?void 0:s.find((e=>t.name===e.name&&t.kind===e.kind))),i=!!(null==o?void 0:o.find((e=>t.name===e.name&&t.kind===e.kind)));this.appendCardinalityText(u,t,a,r,d,c,n,e,i)}const p=this.createSvgText("",[this.className.NODE_TITLE,n?this.className.SELECTED:""]);p.setAttribute("x",String(a+this.options.marginX)),p.setAttribute("y",r.toString()),p.setAttribute("cursor","pointer"),p.classList.add("unselectable");const v=this.createTextLines(t,this.options.nodeColumnWidth-this.options.nodeWidth);v.forEach(((t,e)=>{const i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("x",String(a+this.options.marginX)),i.setAttribute("dy","1.2em"),i.textContent=t.text,i.classList.add(t.class),p.appendChild(i)})),u.appendChild(p);const f=this.createCopyIcon(a,l,r,v[0].text);u.appendChild(f),(null==t?void 0:t.placeHolder)||this.addHoverAndClickEvents(u,m,t),h.appendChild(u),n&&!(null==t?void 0:t.placeHolder)&&this.contextMenuCallbackFunction&&h.appendChild(this.renderElipsisMenu(a,r,t))})),h}createCopyIcon(t,e,i,n){const s=document.createElementNS("http://www.w3.org/2000/svg","text");return s.setAttribute("x",String(t+e-this.options.marginX)),s.setAttribute("y",String(i+this.options.marginX)),s.style.cursor="pointer",s.textContent="⧉",s.setAttribute("class","svg-copy-icon"),s.addEventListener("click",(t=>{t.stopPropagation(),navigator.clipboard.writeText(n).then((()=>{s.textContent="✓",setTimeout((()=>s.textContent="⧉"),1e3)}))})),s}createCircle(t,e,i,n){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("cx",t.toString()),s.setAttribute("cy",e.toString()),s.setAttribute("r",i.toString()),s.setAttribute("fill",n),s}createRect(t,e,i,n,s,o="1"){const a=document.createElementNS(this.SVG_NS,"rect");return a.setAttribute("x",t.toString()),a.setAttribute("y",e.toString()),a.setAttribute("width",i.toString()),a.setAttribute("height",n.toString()),a.setAttribute("rx","5"),a.setAttribute("ry","5"),a.setAttribute("fill",s),a.setAttribute("opacity",o),a}appendCardinalityText(t,e,i,n,s,o,a,r,d){var l,h,c,u,m,g,p,v,f,S,k,b;if(null!==(h=null===(l=e.cardinality)||void 0===l?void 0:l.sourceCount)&&void 0!==h&&h){const d=(null===(c=this.chartData)||void 0===c?void 0:c.allNodesLoaded)||a||r,l=(null===(u=e.cardinality)||void 0===u?void 0:u.sourceCount)+(d?"":"..*")+((null!==(g=null===(m=e.cardinality)||void 0===m?void 0:m.sameKindCount)&&void 0!==g?g:0)>0?"+"+(null!==(v=null===(p=e.cardinality)||void 0===p?void 0:p.sameKindCount)&&void 0!==v?v:0):""),h=this.createSvgText("- "+l,[this.className.CARDINALITY,a?this.className.SELECTED:""]);h.setAttribute("x",String(i+this.options.marginX-6)),h.setAttribute("y",String(n+s-2)),h.setAttribute("fill",o),t.appendChild(h)}if(null!==(S=null===(f=e.cardinality)||void 0===f?void 0:f.targetCount)&&void 0!==S&&S){const r=(null===(k=this.chartData)||void 0===k?void 0:k.allNodesLoaded)||a||d,l=(null===(b=e.cardinality)||void 0===b?void 0:b.targetCount)+(r?"":"..*"),h=this.createSvgText(l+" -",[this.className.CARDINALITY,a?this.className.SELECTED:""]);h.setAttribute("x",String(i+this.options.marginX-14)),h.setAttribute("y",String(n+s-2)),h.setAttribute("fill",o),h.setAttribute("text-anchor","end"),t.appendChild(h)}}createTextLines(t,e){const i=[{text:this.truncateText?this.truncateText(t.title?t.title:t.name,e):t.title?t.title:t.name,class:"headline"}];if(t.subtitle){const n=this.truncateText?this.truncateText(t.subtitle,e):t.subtitle;i.splice(1,0,{text:n,class:"subtitle"})}if(t.tags){const n=this.truncateText?this.truncateText(t.tags.join(", "),e):t.tags.join(", ");i.push({text:n,class:"description"})}return this.options.renderKindAsColums||i.push({text:t.kind.charAt(0).toUpperCase()+t.kind.slice(1),class:"description"}),i}addHoverAndClickEvents(t,e,i){t.addEventListener("click",(t=>{var e;null===(e=this.chartData)||void 0===e||e.selectNode(i),this.render(),this.eventHandler.dispatchEvent("selectionChanged",{node:i,position:{y:this.selectedNodePositionY}})})),t.addEventListener("mouseenter",(t=>{e.setAttribute("opacity",this.options.selectedNode.hoverOpacity.toString())})),t.addEventListener("mouseleave",(t=>{e.setAttribute("opacity","0")}))}createSvgText(t,e){const i=document.createElementNS(this.SVG_NS,"text");return i.classList.add(...e.filter((t=>t))),i.textContent=t,i}renderRelations(t,e){const{name:i,kind:n}=e||{},s=JSON.parse(JSON.stringify(this.nodePositions)),o=document.createElementNS(this.SVG_NS,"g"),a=document.createElementNS(this.SVG_NS,"g");null==t||t.forEach((t=>{var r,d,l,h,c,u;const m=s[t.source.kind+"::"+t.source.name],g=s[t.target.kind+"::"+t.target.name];if(!g||!m)return;const p=t.source.kind===t.target.kind,v=p?g.color:m.color,f=p?0:this.calculateGap(m.sourceIndex++),S=null!==(r=m.textLinesHeight)&&void 0!==r?r:0;S>0&&(m.textLinesHeight=0),m.accumulatedSourceY+=S+f;const k=p?0:this.calculateGap(g.targetIndex++);g.accumulatedTargetY=(null!==(d=g.accumulatedTargetY)&&void 0!==d?d:0)+k;const{source:b,target:C,height:y}=t,N=m.x+this.options.nodeWidth,w=m.sourceY+(y||0)/2+m.accumulatedSourceY,x=this.options.marginY+g.targetY+(y||0)/2+g.accumulatedTargetY,A=(m.x+this.options.nodeWidth+g.x)/2;let E,T=this.options.relation.opacity,D=y;if((t.source.kind===n&&t.source.name===i||t.target.kind===n&&t.target.name===i)&&(T+=this.options.relation.selectedOpacity),b.kind===C.kind){if(m.index<g.index){const t=m.x+this.options.nodeWidth/2,e=m.y+m.height,i=g.x+this.options.nodeWidth/2,n=g.y+g.height/2;E=`M${t},${e} C${t},${n} ${t},${n} ${i},${n}`}else{const t=m.x+this.options.nodeWidth/2,e=m.y+m.height/2,i=g.x+this.options.nodeWidth/2;E=`M${i},${g.y+g.height} C${i},${e} ${i},${e} ${t},${e}`}T=.8,D=2}else E=`M${N},${w} C${A},${w} ${A},${x} ${g.x},${x}`;const V=document.createElementNS("http://www.w3.org/2000/svg","path");let M;if(V.setAttribute("d",E),V.setAttribute("fill","none"),V.setAttribute("stroke-width",String(D||0)),V.setAttribute("stroke",v),a.appendChild(V),M);else{M=t.analytics;t.target.kind===(null==e?void 0:e.kind)||(t.source.kind,null==e||e.kind)}if(null!==(l=null==M?void 0:M.traffic)&&void 0!==l&&l){const t=this.createSvgText("",[this.className.RELATION]);t.setAttribute("x",String(g.x-this.options.marginY)),t.setAttribute("y",String(g.targetY+(y||0)+k)),t.setAttribute("text-anchor","end");const e=document.createElementNS(this.SVG_NS,"tspan");if(e.textContent=(null==M?void 0:M.environment)||"",t.appendChild(e),(null==M?void 0:M.environment)&&this.options.relation.environment[null==M?void 0:M.environment]&&V.setAttribute("stroke-dasharray",this.options.relation.environment[M.environment].dashArray),null!==(h=null==M?void 0:M.errors)&&void 0!==h&&h){const e=100/(null!==(c=null==M?void 0:M.traffic)&&void 0!==c?c:0)*(null!==(u=null==M?void 0:M.errors)&&void 0!==u?u:0),i=document.createElementNS(this.SVG_NS,"tspan");i.setAttribute("fill","red"),i.textContent=" "+(0==e?"(<0.01%)":"("+e.toFixed(2).toLocaleString()+"%)"),t.appendChild(i)}const i=document.createElementNS(this.SVG_NS,"tspan");i.textContent=" "+(null==M?void 0:M.traffic.toLocaleString()),t.appendChild(i),o.appendChild(t),T+=this.options.relation.analyticsOpacity}m.sourceY+=null!=y?y:0,g.targetY+=null!=y?y:0,V.setAttribute("opacity",String(T))})),this.svgElement.appendChild(a),this.svgElement.appendChild(o)}render(){var t,e,i,n,s,o,a;if(!this.chartData)return;const r=null===(t=this.chartData)||void 0===t?void 0:t.getSelectedNode();this.resetSvg(),this.nodePositions={};const d=null!==(i=null===(e=this.chartData)||void 0===e?void 0:e.getNodes())&&void 0!==i?i:[];d.forEach(((t,e)=>{const i=t.kind+"::"+t.name;this.nodePositions[i]={color:t.color||this.options.defaultNodeColor,index:e,sourceRelations:{height:0,count:0},targetRelations:{height:0,count:0},x:0,y:0,height:0,textLinesHeight:0,sourceY:0,targetY:0,sourceIndex:0,targetIndex:0,accumulatedSourceY:0,accumulatedTargetY:0}})),this.updateRelationWeights(null!==(s=null===(n=this.chartData)||void 0===n?void 0:n.getRelations())&&void 0!==s?s:[]);let l=0;const h=this.options.nodeColumnWidth+this.options.nodeWidth,c=null===(o=this.chartData)||void 0===o?void 0:o.getKinds();this.selectedNodePositionY=-1;const u=document.createElementNS(this.SVG_NS,"g");if(c&&c.length>0){const t=r?this.getDirectTargetNodesOf(r):[],e=r?this.getDirectSourceNodesOf(r):[];c.forEach((i=>{var n,s;u.appendChild(this.renderNodes(null!==(s=null===(n=this.chartData)||void 0===n?void 0:n.getNodesByKind(i.name))&&void 0!==s?s:[],this.options.leftX+h*l++,r,i,t,e))}))}else u.appendChild(this.renderNodes(d,this.options.leftX+0));this.renderRelations(null===(a=this.chartData)||void 0===a?void 0:a.getRelations(),r),this.svgElement.appendChild(u),this.updateHeight()}updateRelationWeights(t){t&&t.forEach((t=>{var e,i;const{source:n,target:s,analytics:o}=t;if(n.kind===s.kind)return;const a=(null==o?void 0:o.traffic)&&o.traffic>0?Math.round(Math.log10(Math.max(o.traffic,2))*(null!==(e=this.options.trafficLog10Factor)&&void 0!==e?e:12)):null!==(i=this.options.relationDefaultWidth)&&void 0!==i?i:10;t.height=a;const r=n.kind+"::"+n.name;if(this.nodePositions[r]){const t=this.nodePositions[r];t.sourceRelations.height+=a+this.calculateGap(t.sourceRelations.count),t.sourceRelations.count+=1}const d=s.kind+"::"+s.name;if(this.nodePositions[d]){const t=this.nodePositions[d];t.targetRelations.height+=a+this.calculateGap(t.targetRelations.count),t.targetRelations.count+=1}}))}calculateGap(t){return Math.min(80,3*t)}};class a{constructor(t,e,i){this.mainViewHeight=0,this.mainViewWidth=0,this.mainViewScrollWidth=0,this.mainViewScrollHeight=0,this.scaleUnitY=1,this.scaleUnitX=1,this.drag=t=>{const e=this.minimapPane.getBoundingClientRect(),i=this.visibleSection.getBoundingClientRect();let n=t.clientX-e.left-i.width/2,s=t.clientY-e.top-i.height/2;n=Math.max(0,Math.min(n,e.width-i.width)),s=Math.max(0,Math.min(s,e.height-i.height));const o=s/((this.minimapPane.scrollHeight>this.minimapPane.clientHeight?e.height:this.miniMapSVG.getBoundingClientRect().height)-i.height),a=n/(e.width-i.width);this.mainView.scrollTop=o*(this.mainViewScrollHeight-this.mainViewHeight),this.mainView.scrollLeft=a*(this.mainViewScrollWidth-this.mainViewWidth)},this.endDrag=()=>{document.removeEventListener("mousemove",this.drag),document.removeEventListener("mouseup",this.endDrag)},this.mainView=i,this.container=e,this.visibleSection=this.createVisibleSection(),this.miniMapSVG=this.createMiniMapSVG(t.id),this.miniMapSVG.appendChild(this.visibleSection),this.minimapPane=this.createMinimapPane(),this.minimapPane.appendChild(this.miniMapSVG),this.container.appendChild(this.minimapPane),this.mainView.addEventListener("scroll",this.syncScroll.bind(this)),this.visibleSection.addEventListener("mousedown",this.startDrag.bind(this));const n=new ResizeObserver((()=>{this.initialize()}));n.observe(this.container),n.observe(this.mainView)}initialize(){this.mainViewHeight=this.mainView.clientHeight,this.mainViewWidth=this.mainView.clientWidth,this.mainViewScrollWidth=this.mainView.scrollWidth,this.mainViewScrollHeight=this.mainView.scrollHeight,this.visibleSection.setAttribute("width",this.mainViewWidth.toString()),this.visibleSection.setAttribute("height",this.mainViewHeight.toString()),this.miniMapSVG.setAttribute("viewBox",`0 0 ${this.mainViewScrollWidth} ${this.mainViewScrollHeight}`),this.mainView.scrollTop=0,this.mainView.scrollLeft=0,this.visibleSection.setAttribute("width",this.mainViewWidth.toString()),this.visibleSection.setAttribute("height",this.mainViewHeight.toString()),this.scaleUnitY=this.mainViewHeight===this.mainViewScrollHeight?1:-1/(this.mainViewHeight-this.mainViewScrollHeight),this.scaleUnitX=this.mainViewWidth===this.mainViewScrollWidth?1:-1/(this.mainViewWidth-this.mainViewScrollWidth),this.minimapPane.style.minHeight=`${this.mainViewHeight}px`,this.minimapPane.style.display="block";const t=Math.min(this.minimapPane.clientHeight,this.mainViewHeight);this.minimapPane.style.minHeight=`${t}px`,this.mainViewHeight===this.mainViewScrollHeight&&this.mainViewWidth===this.mainViewScrollWidth&&(this.minimapPane.style.display="none"),this.syncScroll()}createMiniMapSVG(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("class","preview-svg");const i=document.createElementNS("http://www.w3.org/2000/svg","use");return i.setAttribute("href",`#${t}`),i.setAttribute("pointer-events","none"),e.appendChild(i),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="auto",e}createMinimapPane(){const t=document.createElement("div");return t.className="minimap-pane",t.style.overflow="hidden",t.style.position="absolute",t.style.right="0",t.style.top="0",t}createVisibleSection(){const t=document.createElementNS("http://www.w3.org/2000/svg","rect");return t.setAttribute("class","minimap-visible-section"),t.setAttribute("x","0"),t.setAttribute("y","0"),t}syncScroll(){const t=this.scaleUnitY*this.mainView.scrollTop,e=this.scaleUnitX*this.mainView.scrollLeft;this.minimapPane.scrollTop=(this.minimapPane.scrollHeight-this.minimapPane.clientHeight)*t,this.minimapPane.scrollLeft=(this.minimapPane.scrollWidth-this.minimapPane.clientWidth)*e;const i=(this.mainViewScrollHeight-this.mainViewHeight)*t,n=(this.mainViewScrollWidth-this.mainViewWidth)*e;this.visibleSection.setAttribute("y",i.toString()),this.visibleSection.setAttribute("x",n.toString())}startDrag(t){t.preventDefault(),document.addEventListener("mousemove",this.drag),document.addEventListener("mouseup",this.endDrag)}}return window.SankeyChart=o,window.SankeyChartData=n,window.EventHandler=s,window.MiniMap=a,i})()));